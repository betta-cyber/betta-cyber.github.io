<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>Linux 文件监控 - B</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=betta-cyber, game, betta, shokill>
  
    <meta name="description" content="betta">
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="B" type="application/atom+xml">
  

  

  

  <!-- <link rel="stylesheet" href="../css/style.css"> -->
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css">

  <!--  -->
    <!-- <link rel="stylesheet" href="../css/font-awesome.min.css"> -->
  <!--  -->

  <script src="/static/js/hexo_resize_image.js"></script>
  <script type="text/javascript" src="/static/js/jquery.min.js"></script>

  <script type='text/javascript' id='clustrmaps' src='//cdn.clustrmaps.com/map_v2.js?cl=ffffff&w=0&t=n&d=b9cDq33TdEsfGb_DpY--uB2pjskzQ8TK9LaE3yuIYzE&co=ffffff&cmo=ffffff&cmn=ffffff&ct=ffffff'></script>
<meta name="generator" content="Hexo 5.4.1"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

  <body>
    <div class="container">
      <header class="header">
  <!-- <div class="blog-title">
    <a href="/" class="logo">B</a>
    <div class="subtitle"></div>
  </div> -->
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link " >Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/blog" class="menu-item-link active" >Blog</a>
        </li>
      
        <li class="menu-item">
          <a href="/ebook" class="menu-item-link " >Ebook</a>
        </li>
      
        <li class="menu-item">
          <a href="/music" class="menu-item-link " >Music</a>
        </li>
      
        <li class="menu-item">
          <a href="/album" class="menu-item-link " >Photo</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link " >About</a>
        </li>
      
    </ul>
  </nav>
</header>


<article class="post">
  <div class="post-title">
    <h1 class="article-title">Linux 文件监控</h1>
  </div>
  <div class="post-content">
    <h1 id="一、方式"><a href="#一、方式" class="headerlink" title="一、方式"></a>一、方式</h1><ol>
<li>stat<br>stat是一个在Linux系统上查看文件或文件系统状态的工具。用获取文件的最近访问时间、修改时间、权限等信息，并编写脚本以定期运行该命令以监控文件状态的变化。</li>
<li>sysdig<br>  sysdig 是一个超级系统工具，可用来捕获系统状态信息。提供命令行接口以及强大的交互界面。支持各种 IO 活动：进程、文件、网络连接等。</li>
<li>inotifywait<br>需要安装inotify-tools。</li>
<li>inotify&#x2F;fanotify<br>Linux 系统调用。</li>
</ol>
<h1 id="二、inotify简介"><a href="#二、inotify简介" class="headerlink" title="二、inotify简介"></a>二、inotify简介</h1><h2 id="2-1-基本原理"><a href="#2-1-基本原理" class="headerlink" title="2.1 基本原理"></a>2.1 基本原理</h2><p>inotify是Linux内核提供的一种文件系统监控机制。它通过在文件系统的目录上设置监视器来跟踪文件和目录的变化。当监视的文件或目录发生指定的事件时，内核会生成相应的事件通知。 从Linux内核2.6.13版本开始支持inotify。</p>
<h2 id="2-2-主要特点"><a href="#2-2-主要特点" class="headerlink" title="2.2 主要特点"></a>2.2 主要特点</h2><p>inotify具有以下主要特点：</p>
<ul>
<li>支持多种事件类型：inotify支持多种事件类型，比如文件访问、修改、属性变化、打开、关闭等，应用程序可以根据需要选择监视的事件类型。</li>
<li>精确性：inotify可以精确地追踪指定目录或文件是移入，还是移出，关闭前是否写入等操作。</li>
<li>灵活性：应用程序可以根据具体需求动态添加和移除监视器，可以对不同的文件和目录设置不同的监视器。</li>
<li>高效性：inotify使用内核回调机制，避免了不必要的轮询操作。<br>这些特点使得inotify成为在Linux系统上实现文件系统监控的重要工具，广泛应用于文件同步、日志监控、自动化部署等领域。</li>
</ul>
<h2 id="2-3-工作方式"><a href="#2-3-工作方式" class="headerlink" title="2.3 工作方式"></a>2.3 工作方式</h2><p>接口说明</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/inotify.h></span></span>

<span class="token keyword">int</span> <span class="token function">inotify_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">inotify_init1</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/*
 * flags：初始化标志，用于指定inotify实例的行为选项。
 * 可以使用以下标志进行设置：
 * IN_CLOEXEC：设置此标志后，在执行exec时会关闭inotify文件描述符。
 * IN_NONBLOCK：设置此标志后，inotify文件描述符将以非阻塞模式打开。
*/</span>

<span class="token keyword">int</span> <span class="token function">inotify_add_watch</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> uint32_t mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* fd： inotify实例的文件描述符。
 * pathname：监视的文件或目录的路径。
 * mask：监视的事件类型，可以是单个事件类型或多个事件类型的组合。
 */</span>

<span class="token keyword">struct</span> inotify_event
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> wd<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//监控事件的文件描述符（watch descriptor）。</span>
  uint32_t mask<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//表示事件的掩码，指定了哪些事件发生时会触发 inotify 通知。</span>
  uint32_t cookie<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//用于关联相关的事件。</span>
  uint32_t len<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//文件或目录名的长度。</span>
  <span class="token keyword">char</span> name __flexarr<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//文件或目录的名称。__flexarr定义为[0]</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用流程：</p>
<ol>
<li>创建inotify实例：应用程序通过调用inotify_init()或inotify_init1()函数创建一个inotify实例，返回一个文件描述符。</li>
<li>添加监视器：应用程序使用inotify_add_watch()函数将要监视的文件或目录添加到inotify实例中，并指定要监视的事件类型。</li>
<li>读取事件：应用程序使用read()函数读取inotify实例的文件描述符，以获取事件通知。</li>
<li>处理事件：应用程序读取到的事件通知，根据事件的类型执行相应的操作。</li>
</ol>
<p>常用14事件：</p>
<ul>
<li>IN_ACCESS：文件被访问（读取）。</li>
<li>IN_MODIFY：文件被修改。</li>
<li>IN_ATTRIB：文件属性发生变化，如权限、所有权或时间戳。</li>
<li>IN_CLOSE_WRITE：文件被关闭（写入完成）。</li>
<li>IN_CLOSE_NOWRITE：文件被关闭，但没有写入操作。</li>
<li>IN_OPEN：文件被打开。</li>
<li>IN_MOVED_FROM：文件被移出监控目录。</li>
<li>IN_MOVED_TO：文件被移入监控目录。</li>
<li>IN_CREATE：文件或目录被创建。</li>
<li>IN_DELETE：文件或目录被删除。</li>
<li>IN_DELETE_SELF：监控的文件或目录本身被删除。</li>
<li>IN_MOVE_SELF：监控的文件或目录本身被移动。</li>
<li>IN_UNMOUNT：文件系统被卸载。</li>
<li>IN_ONESHOT：只会触发一次事件通知<ol>
<li>事件标志是用于指定一个 inotify 监听只会触发一次事件通知。这对于某些场景很有用，一旦触发了一次事件通知，不再需要继续监听的情况下，可以节省资源并简化代码逻辑。</li>
<li>需要注意的是，IN_ONESHOT 事件标志仅适用于单个事件。即使注册时设置了 IN_ONESHOT 标志，如果同一个文件或目录上发生多个事件，每个事件都会触发一个事件通知。只有当前注册的事件完成后，才会取消监听该。</li>
<li>此外，需要注意不同版本的 Linux 内核对 IN_ONESHOT 的支持可能会有所差异，请确保在目标系统上的内核版本中支持该标志。</li>
</ol>
</li>
</ul>
<p>实例演示：<br>统计写falsh次数，防止高频度写falsh引发坏块。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/inotify.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> MAX_EVENTS 1024</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EVENT_SIZE  (sizeof(struct inotify_event))</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BUFFER_SIZE (MAX_EVENTS * (sizeof(struct inotify_event) + 16))</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc <span class="token punctuation">,</span><span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">,</span> wd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> inotify_event <span class="token operator">*</span>event<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    ssize_t len<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span> path <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 创建inotify实例</span>
    fd <span class="token operator">=</span> <span class="token function">inotify_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"inotify_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 添加监控的文件路径，并指定要监控的事件</span>
    wd <span class="token operator">=</span> <span class="token function">inotify_add_watch</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> path<span class="token punctuation">,</span> IN_MODIFY <span class="token operator">|</span> IN_OPEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>wd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"inotify_add_watch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 读取inotify事件</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 解析inotify事件</span>
        event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> inotify_event <span class="token operator">*</span><span class="token punctuation">)</span> buffer<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>len <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>mask <span class="token operator">&amp;</span> IN_MODIFY<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"File modified: %s num:%lld\n"</span><span class="token punctuation">,</span> event<span class="token operator">-></span>name<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
                num<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>mask <span class="token operator">&amp;</span> IN_OPEN<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"File opened: %s\n"</span><span class="token punctuation">,</span> event<span class="token operator">-></span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 指向下一个事件</span>
            event <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> inotify_event <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> event <span class="token operator">+</span> EVENT_SIZE <span class="token operator">+</span> event<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            len <span class="token operator">-</span><span class="token operator">=</span> EVENT_SIZE <span class="token operator">+</span> event<span class="token operator">-></span>len<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 关闭inotify实例</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上实现了监控打开、修改两种种事件监控，当触发对应事件，会打印输出被操作的目录或文件名称，同时会输出修改文件次数。</p>
<h2 id="2-4-开源项目中的应用"><a href="#2-4-开源项目中的应用" class="headerlink" title="2.4 开源项目中的应用"></a>2.4 开源项目中的应用</h2><ul>
<li>文件自动同步的功能：使用inotify来监控文件的变化，通过rsync同步。<ul>
<li>inotify-tools：一组命令行工具，包括inotifywait和inotifywatch，用于监控文件系统事件。</li>
<li>inoticoming：是一个基于 inotify 机制的工具，用于在 Linux 系统上监视文件系统事件并执行相应的命令。</li>
</ul>
</li>
<li>Systemd：Linux系统初始化和管理守护进程，使用inotify来监控系统日志文件的变化。</li>
<li>Android系统WiFi管理器：通过inotify监控wpa_supplicant.conf文件变化，读取新的配置信息。</li>
</ul>
<h3 id="2-5-注意事项"><a href="#2-5-注意事项" class="headerlink" title="2.5 注意事项"></a>2.5 注意事项</h3><ol>
<li>文件描述符限制：Linux 系统对打开的文件描述符数量有限制，因此在监控大量文件或目录时，可能会超出文件描述符限制。可以使用 ulimit  命令或调整系统配置文件来增加文件描述符数量限制。<br>文件描述符限制对于使用 inotify 监控文件系统特别重要。当使用 inotify 监控大量的文件或目录时，每个监控项都需要占用一个文件描述符。如果超过了进程的文件描述符限制，就无法继续创建新的监控项。</li>
<li>内核限制：Linux 内核也对 inotify 实例数量和队列大小有限制。可以通过修改 &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;inotify 目录下的文件来调整这些限制。<br>max_user_instances 表示每个用户可创建的 inotify 实例数量的最大限制。每个实例可以监视多个文件或目录。一般默认是128。<br>max_user_watches 表示每个用户可创建的监控项（watch）的最大数量。监控项是 inotify 实例中用于监控文件或目录的对象。一般默认是 8192。<br> max_queued_events 表示每个 inotify 实例的事件队列的最大容量。事件队列用于存储待处理的事件通知。一般默认是16384。</li>
<li>监控路径的长度限制： 对于每个inotify实例，路径长度限制为通常是4096个字节。如果路径超过这个限制，inotify_add_watch函数会返回ENAMETOOLONG错误。</li>
<li>文件系统限制：大部分Linux文件系统都支持inotify。但网络文件系统（如 NFS）一般不支持 inotify。在使用 inotify 时，确保文件系统支持和兼容性。</li>
<li>事件溢出：如果事件队列满了，新的事件将被丢弃，这可能导致丢失重要的事件。可以通过适当调整事件队列的大小或及时处理事件来避免事件溢出。</li>
<li>性能开销：inotify 监控是实时的，对于大量文件或目录的监控可能带来较大的性能开销。可以通过使用批量处理、事件队列、并发处理等技术来优化性能，减少系统调用次数。</li>
<li>注意事件顺序：inotify 提供的事件顺序是不可靠的，即不能保证事件的顺序。在处理事件时，要谨慎处理，并避免对事件顺序有依赖的操作。</li>
</ol>
<h3 id="2-6-常见问题"><a href="#2-6-常见问题" class="headerlink" title="2.6 常见问题"></a>2.6 常见问题</h3><ol>
<li>实现监控子目录<br>除了监控单个文件，inotify还可以监控整个目录，但只能监控一级目录，二级及以下子目录是不支持的，需要通过inotify_add_watch添加子目录。建议单独启动线程遍历整个目录逐一添加，监控到创建子目录事件时，再添加到监控。</li>
<li>批量处理事件<br>当有大量事件到达时，处理每个事件可能会带来性能问题。可以考虑以下方式解决。</li>
</ol>
<ul>
<li>事件缓冲区： 创建一个事件缓冲区，用于存储inotify事件。当有新的事件到达时，将其添加到缓冲区中，而不立即处理事件。这样可以避免在处理一个事件时，另一个事件到达导致的中断。</li>
<li>事件合并： 如果多个事件发生在同一个文件上，并且这些事件之间的时间间隔很短，你可以考虑将它们合并为一个事件进行处理。例如，如果一个文件在短时间内连续被修改了多次，你可以只触发一次处理操作，而不是每次修改都触发。</li>
<li>并发处理： 使用多线程或多进程来并发处理事件。将事件分发给多个处理线程或进程，可以并行处理多个事件，提高处理速度。但要注意避免并发处理导致的竞态条件和资源冲突问题。</li>
</ul>
<ol start="3">
<li>无法追踪操作的进程。</li>
</ol>
<ul>
<li>结合进程监控工具：如 lsof、fuser 或 ltrace<br>局限：嵌入式设备系统上没有lsof、strace等命令。</li>
</ul>
<h1 id="三、fanotify简介"><a href="#三、fanotify简介" class="headerlink" title="三、fanotify简介"></a>三、fanotify简介</h1><p>特性与优势</p>
<ul>
<li>追踪操作文件的进程</li>
<li>支持操作阻断</li>
<li>支持整个目录监控，inotify仅支持一级目录监控，其子目录不在监控范围。<br>使用场景</li>
<li>文件安全监控与防篡改</li>
<li>行为分析与审计</li>
<li>实时反病毒扫描</li>
<li>文件同步和备份</li>
</ul>
<p>接口介绍</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/fanotify.h></span></span>

<span class="token keyword">int</span> <span class="token function">fanotify_init</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> event_f_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/*
flags: 通知类别
  FAN_CLASS_NOTIF 默认值。不需要指定。该值仅允许接收通知的事件。
  FAN_CLASS_CONTENT 监控文件或者目录状态变化，给出阻止/放行的决定
  FAN_NONBLOCK 以非阻塞模式打开
  FAN_CLOEXEC 在执行exec时会关闭fanotify文件描述符
event_f_flags：文件状态标志，比如O_RDONLY O_RDONLY  O_LARGEFILE
*/</span>
<span class="token keyword">int</span> <span class="token function">fanotify_mark</span><span class="token punctuation">(</span><span class="token keyword">int</span> fanotify_fd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> uint64_t mask<span class="token punctuation">,</span>
                <span class="token keyword">int</span> dirfd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/*
fanotify_fd：fanotify 文件描述符，通过 fanotify_init 函数获得。
flags：标记选项，可以使用 FAN_MARK_ADD 或 FAN_MARK_REMOVE 进行添加或移除标记。
mask：要监控的事件掩码，指定的事件类型。例如，FAN_OPEN | FAN_CLOSE_WRITE 表示你希望监控打开和写入关闭的事件。
dirfd：目标文件或目录所在的文件描述符。
pathname：目标文件或目录的路径。
*/</span>

<span class="token keyword">struct</span> fanotify_event_metadata <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    __u32 event_len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//事件的长度，包括元数据结构体在内的整个事件的字节数。</span>
    __u8 vers<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// fanotify 版本号。</span>
    __u8 reserved<span class="token punctuation">;</span>
    __u16 metadata_len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//元数据结构体的长度。</span>
    __aligned_u64 mask<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//表示事件的掩码，指定了哪些事件发生时会触发 fanotify 通知。</span>
    __s32 fd<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//与事件相关的文件描述符。</span>
    __s32 pid<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//产生事件的进程的 PID。</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> fanotify_response <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    __s32 fd<span class="token punctuation">;</span>
    __u32 response<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* Legit userspace responses to a _PERM event */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FAN_ALLOW   0x01</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FAN_DENY    0x02</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FAN_AUDIT   0x10    </span><span class="token comment" spellcheck="true">/* Bit mask to create audit record for result */</span>

<span class="token function">FAN_EVENT_OK</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> len<span class="token punctuation">)</span>
<span class="token function">FAN_EVENT_NEXT</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> len<span class="token punctuation">)</span>
常见事件
<span class="token operator">-</span> FAN_ACCESS：文件被访问时触发事件。
<span class="token operator">-</span> FAN_MODIFY：文件被修改时触发事件。
<span class="token operator">-</span> FAN_CLOSE_WRITE：文件被写入并关闭时触发事件。
<span class="token operator">-</span> FAN_CLOSE_NOWRITE：文件被关闭而没有写入时触发事件。
<span class="token operator">-</span> FAN_OPEN：文件被打开时触发事件。
<span class="token operator">-</span> FAN_OPEN_PERM：文件被打开且检查了权限时触发事件。
<span class="token operator">-</span> FAN_ATTRIB：文件属性发生变化时触发事件。
<span class="token operator">-</span> FAN_CREATE：文件或目录被创建时触发事件。
<span class="token operator">-</span> FAN_DELETE：文件或目录被删除时触发事件。
<span class="token operator">-</span> FAN_DELETE_SELF：监控的文件或目录本身被删除时触发事件。
<span class="token operator">-</span> FAN_MOVE：文件或目录被移动时触发事件。
<span class="token operator">-</span> FAN_MOVE_SELF：监控的文件或目录本身被移动时触发事件。
<span class="token operator">-</span> FAN_CLOSE：文件被关闭时触发事件（包括写入和未写入的情况）。
<span class="token operator">-</span> FAN_ALL_EVENTS：所有事件的组合，用于方便地监控所有事件。
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>fanotify实例演示<br>示例1<br>根据监控事件，获取对应修改文件的程序名称及被修改文件名称</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> _GNU_SOURCE</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;signal.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;poll.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;errno.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;limits.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/signalfd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;linux/fanotify.h></span></span>

<span class="token comment" spellcheck="true">/* Structure to keep track of monitored directories */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">/* Path of the directory */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> monitored_t<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* Size of buffer to use when reading fanotify events */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> FANOTIFY_BUFFER_SIZE 8192</span>

<span class="token comment" spellcheck="true">/* Enumerate list of FDs to poll */</span>
<span class="token keyword">enum</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
  FD_POLL_SIGNAL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  FD_POLL_FANOTIFY<span class="token punctuation">,</span>
  FD_POLL_MAX
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/* Setup fanotify notifications (FAN) mask. All these defined in fanotify.h. */</span>
<span class="token keyword">static</span> uint64_t event_mask <span class="token operator">=</span>
  <span class="token punctuation">(</span>FAN_ACCESS <span class="token operator">|</span>
   FAN_MODIFY <span class="token operator">|</span>
   FAN_CLOSE_WRITE <span class="token operator">|</span>
   FAN_CLOSE_NOWRITE <span class="token operator">|</span>
   FAN_OPEN <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/* Array of directories being monitored */</span>
<span class="token keyword">static</span> monitored_t <span class="token operator">*</span>monitors<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> n_monitors<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">get_program_name_from_pid</span> <span class="token punctuation">(</span><span class="token keyword">int</span>     pid<span class="token punctuation">,</span><span class="token keyword">char</span>   <span class="token operator">*</span>buffer<span class="token punctuation">,</span>size_t  buffer_size<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    ssize_t len<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>aux<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Try to get program name by PID */</span>
    <span class="token function">sprintf</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token string">"/proc/%d/cmdline"</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">open</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Read file contents into buffer */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token function">read</span> <span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> buffer_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">close</span> <span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token function">close</span> <span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    buffer<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    aux <span class="token operator">=</span> <span class="token function">strstr</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token string">"^@"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aux<span class="token punctuation">)</span>
        <span class="token operator">*</span>aux <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">get_file_path_from_fd</span> <span class="token punctuation">(</span><span class="token keyword">int</span>     fd<span class="token punctuation">,</span> <span class="token keyword">char</span>   <span class="token operator">*</span>buffer<span class="token punctuation">,</span> size_t  buffer_size<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    ssize_t len<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">sprintf</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token string">"/proc/self/fd/%d"</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> <span class="token function">readlink</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> buffer_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    buffer<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'\0'</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">event_process</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> fanotify_event_metadata <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> path<span class="token punctuation">[</span>PATH_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Received event in path '%s'"</span><span class="token punctuation">,</span>
            <span class="token function">get_file_path_from_fd</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>fd<span class="token punctuation">,</span>path<span class="token punctuation">,</span>PATH_MAX<span class="token punctuation">)</span> <span class="token operator">?</span> path <span class="token punctuation">:</span> <span class="token string">"unknown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">" pid=%d (%s): \n"</span><span class="token punctuation">,</span>event<span class="token operator">-></span>pid<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token function">get_program_name_from_pid</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>pid<span class="token punctuation">,</span>path<span class="token punctuation">,</span>
            PATH_MAX<span class="token punctuation">)</span> <span class="token operator">?</span> path <span class="token punctuation">:</span> <span class="token string">"unknown"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>mask <span class="token operator">&amp;</span> FAN_OPEN<span class="token punctuation">)</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"\tFAN_OPEN\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>mask <span class="token operator">&amp;</span> FAN_ACCESS<span class="token punctuation">)</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"\tFAN_ACCESS\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>mask <span class="token operator">&amp;</span> FAN_MODIFY<span class="token punctuation">)</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"\tFAN_MODIFY\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>mask <span class="token operator">&amp;</span> FAN_CLOSE_WRITE<span class="token punctuation">)</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"\tFAN_CLOSE_WRITE\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>mask <span class="token operator">&amp;</span> FAN_CLOSE_NOWRITE<span class="token punctuation">)</span>
        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"\tFAN_CLOSE_NOWRITE\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fflush</span> <span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">close</span> <span class="token punctuation">(</span>event<span class="token operator">-></span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shutdown_fanotify</span> <span class="token punctuation">(</span><span class="token keyword">int</span> fanotify_fd<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_monitors<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Remove the mark, using same event mask as when creating it */</span>
        <span class="token function">fanotify_mark</span> <span class="token punctuation">(</span>fanotify_fd<span class="token punctuation">,</span>FAN_MARK_REMOVE<span class="token punctuation">,</span>event_mask<span class="token punctuation">,</span>AT_FDCWD<span class="token punctuation">,</span>
                        monitors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">free</span> <span class="token punctuation">(</span>monitors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token function">free</span> <span class="token punctuation">(</span>monitors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span> <span class="token punctuation">(</span>fanotify_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">initialize_fanotify</span> <span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">int</span> fanotify_fd<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
    FAN_CLASS_NOTIF: 默认值，可以不配置
    FAN_CLOEXEC: 表示在执行 exec 类系统调用时关闭 fanotify 文件描述符。使用这个标志位可以确保在子进程中不会继承 fanotify 的文件描述符。
    O_RDONLY : 表示以只读模式打开文件
    O_CLOEXEC : 表示在执行 exec 类系统调用时关闭文件描述符。
    */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fanotify_fd <span class="token operator">=</span> <span class="token function">fanotify_init</span> <span class="token punctuation">(</span>FAN_CLASS_NOTIF<span class="token operator">|</span>FAN_CLOEXEC<span class="token punctuation">,</span>O_RDONLY <span class="token operator">|</span> O_CLOEXEC
                                     <span class="token operator">|</span> O_LARGEFILE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token function">fprintf</span> <span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
               <span class="token string">"Couldn't setup new fanotify device: %s\n"</span><span class="token punctuation">,</span>
               <span class="token function">strerror</span> <span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Allocate array of monitor setups */</span>
    n_monitors <span class="token operator">=</span> argc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    monitors <span class="token operator">=</span> <span class="token function">malloc</span> <span class="token punctuation">(</span>n_monitors <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>monitored_t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Loop all input directories, setting up marks */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n_monitors<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        monitors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token function">strdup</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Add new fanotify mark */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fanotify_mark</span> <span class="token punctuation">(</span>fanotify_fd<span class="token punctuation">,</span>FAN_MARK_ADD<span class="token punctuation">,</span>event_mask<span class="token punctuation">,</span>AT_FDCWD<span class="token punctuation">,</span>
                    monitors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
          <span class="token function">fprintf</span> <span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Couldn't add monitor in directory '%s': '%s'\n"</span><span class="token punctuation">,</span>
                   monitors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">,</span><span class="token function">strerror</span> <span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Started monitoring directory '%s'...\n"</span><span class="token punctuation">,</span> monitors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> fanotify_fd<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">shutdown_signals</span> <span class="token punctuation">(</span><span class="token keyword">int</span> signal_fd<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">close</span> <span class="token punctuation">(</span>signal_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">initialize_signals</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> signal_fd<span class="token punctuation">;</span>
    sigset_t sigmask<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* We want to handle SIGINT and SIGTERM in the signal_fd, so we block them. */</span>
    <span class="token function">sigemptyset</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>sigmask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigaddset</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>sigmask<span class="token punctuation">,</span> SIGINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sigaddset</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>sigmask<span class="token punctuation">,</span> SIGTERM<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sigprocmask</span> <span class="token punctuation">(</span>SIG_BLOCK<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sigmask<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">fprintf</span> <span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Couldn't block signals: '%s'\n"</span><span class="token punctuation">,</span><span class="token function">strerror</span> <span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* Get new FD to read signals from it */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>signal_fd <span class="token operator">=</span> <span class="token function">signalfd</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sigmask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token function">fprintf</span> <span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Couldn't setup signal FD: '%s'\n"</span><span class="token punctuation">,</span><span class="token function">strerror</span> <span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> signal_fd<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> signal_fd<span class="token punctuation">;</span>
    <span class="token keyword">int</span> fanotify_fd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> pollfd fds<span class="token punctuation">[</span>FD_POLL_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Input arguments... */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">fprintf</span> <span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Usage: %s directory1 [directory2 ...]\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span> <span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Initialize signals FD */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>signal_fd <span class="token operator">=</span> <span class="token function">initialize_signals</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">fprintf</span> <span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't initialize signals\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span> <span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Initialize fanotify FD and the marks */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fanotify_fd <span class="token operator">=</span> <span class="token function">initialize_fanotify</span> <span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">fprintf</span> <span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Couldn't initialize fanotify\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span> <span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Setup polling */</span>
    fds<span class="token punctuation">[</span>FD_POLL_SIGNAL<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> signal_fd<span class="token punctuation">;</span>
    fds<span class="token punctuation">[</span>FD_POLL_SIGNAL<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>
    fds<span class="token punctuation">[</span>FD_POLL_FANOTIFY<span class="token punctuation">]</span><span class="token punctuation">.</span>fd <span class="token operator">=</span> fanotify_fd<span class="token punctuation">;</span>
    fds<span class="token punctuation">[</span>FD_POLL_FANOTIFY<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>
    <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Block until there is something to be read */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">poll</span> <span class="token punctuation">(</span>fds<span class="token punctuation">,</span> FD_POLL_MAX<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">fprintf</span> <span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Couldn't poll(): '%s'\n"</span><span class="token punctuation">,</span><span class="token function">strerror</span> <span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span> <span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* Signal received? */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fds<span class="token punctuation">[</span>FD_POLL_SIGNAL<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">struct</span> signalfd_siginfo fdsi<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">read</span> <span class="token punctuation">(</span>fds<span class="token punctuation">[</span>FD_POLL_SIGNAL<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span><span class="token operator">&amp;</span>fdsi<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>fdsi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span>fdsi<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">fprintf</span> <span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Couldn't read signal, wrong size read\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">exit</span> <span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/* Break loop if we got the expected signal */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fdsi<span class="token punctuation">.</span>ssi_signo <span class="token operator">==</span> SIGINT <span class="token operator">||</span> fdsi<span class="token punctuation">.</span>ssi_signo <span class="token operator">==</span> SIGTERM<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token function">fprintf</span> <span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span><span class="token string">"Received unexpected signal\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fds<span class="token punctuation">[</span>FD_POLL_FANOTIFY<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> POLLIN<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>FANOTIFY_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
            ssize_t length<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/* Read from the FD. It will read all events available up to
            * the given buffer size. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>length <span class="token operator">=</span> <span class="token function">read</span> <span class="token punctuation">(</span>fds<span class="token punctuation">[</span>FD_POLL_FANOTIFY<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span>buffer<span class="token punctuation">,</span>FANOTIFY_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token keyword">struct</span> fanotify_event_metadata <span class="token operator">*</span>metadata<span class="token punctuation">;</span>

                metadata <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> fanotify_event_metadata <span class="token operator">*</span><span class="token punctuation">)</span>buffer<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">FAN_EVENT_OK</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">event_process</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token operator">-></span>fd <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token function">close</span> <span class="token punctuation">(</span>metadata<span class="token operator">-></span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    metadata <span class="token operator">=</span> <span class="token function">FAN_EVENT_NEXT</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/* Clean exit */</span>
  <span class="token function">shutdown_fanotify</span> <span class="token punctuation">(</span>fanotify_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">shutdown_signals</span> <span class="token punctuation">(</span>signal_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">printf</span> <span class="token punctuation">(</span><span class="token string">"Exiting fanotify example...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>示例2<br>拦截访问</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/fanotify.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> MAX_EVENTS 10</span>
<span class="token macro property">#<span class="token directive keyword">define</span> EVENT_SIZE (sizeof(struct fanotify_event_metadata) + 100)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> BUFFER_SIZE (MAX_EVENTS * EVENT_SIZE)</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>path <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> fanotify_fd <span class="token operator">=</span> <span class="token function">fanotify_init</span><span class="token punctuation">(</span>FAN_CLASS_CONTENT <span class="token operator">|</span> FAN_CLOEXEC <span class="token punctuation">,</span> O_RDONLY <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fanotify_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fanotify_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> wd <span class="token operator">=</span> <span class="token function">fanotify_mark</span><span class="token punctuation">(</span>fanotify_fd<span class="token punctuation">,</span> FAN_MARK_ADD<span class="token punctuation">,</span> FAN_OPEN_PERM<span class="token punctuation">,</span> AT_FDCWD<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>wd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"fanotify_mark"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    ssize_t len<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> fanotify_event_metadata <span class="token operator">*</span>metadata<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        len <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fanotify_fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        metadata <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> fanotify_event_metadata <span class="token operator">*</span><span class="token punctuation">)</span>buffer<span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">FAN_EVENT_OK</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token operator">-></span>mask <span class="token operator">&amp;</span> FAN_OPEN_PERM<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"FAN_OPEN_PERM\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">struct</span> fanotify_response response<span class="token punctuation">;</span>
                response<span class="token punctuation">.</span>fd <span class="token operator">=</span> metadata<span class="token operator">-></span>fd<span class="token punctuation">;</span>
                response<span class="token punctuation">.</span>response <span class="token operator">=</span> FAN_DENY<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//FAN_ALLOW</span>

                <span class="token comment" spellcheck="true">// 发送阻拦响应</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>fanotify_fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>response<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token function">fflush</span> <span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">close</span> <span class="token punctuation">(</span>metadata<span class="token operator">-></span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 进一步处理其他事件...</span>

            metadata <span class="token operator">=</span> <span class="token function">FAN_EVENT_NEXT</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>拦截流程：<br><img src="/../images/%E6%B5%81%E7%A8%8B.png" alt="图片"></p>
<p>注意事项</p>
<ul>
<li>特权要求：fanotify需要root权限，请确保你有足够的权限来进行文件系统监控。</li>
<li>监控范围：fanotify 可以用于监控整个文件系统，若文件数量太过庞大，面临性能瓶颈和资源限制。</li>
<li>兼容性：fanotify 是 Linux 特定的机制，在其他操作系统或平台上可能不可用或工作方式不同。确保你的应用程序的目标环境支持 fanotify。</li>
</ul>

  </div>
  <div class="post-footer">
    

    <a href="#top" class="top">↑</a>
  </div>
</article>
<footer>
  &copy; 2024
  <span class="author">
    betta
  </span>
</footer>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/static/js/codeBlockFunction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/static/js/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/static/js/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/static/js/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
  </body>
</html>
