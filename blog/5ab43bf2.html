<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>Rust 和 OpenResty 的性能问题 - B</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=betta-cyber, game, betta, shokill>
  
    <meta name="description" content="betta">
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="B" type="application/atom+xml">
  

  

  

  <!-- <link rel="stylesheet" href="../css/style.css"> -->
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css">

  <!--  -->
    <!-- <link rel="stylesheet" href="../css/font-awesome.min.css"> -->
  <!--  -->

  <script src="/static/js/hexo_resize_image.js"></script>
  <script type="text/javascript" src="/static/js/jquery.min.js"></script>

  <script type='text/javascript' id='clustrmaps' src='//cdn.clustrmaps.com/map_v2.js?cl=ffffff&w=0&t=n&d=b9cDq33TdEsfGb_DpY--uB2pjskzQ8TK9LaE3yuIYzE&co=ffffff&cmo=ffffff&cmn=ffffff&ct=ffffff'></script>
<meta name="generator" content="Hexo 5.4.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <!-- <div class="blog-title">
    <a href="/" class="logo">B</a>
    <div class="subtitle"></div>
  </div> -->
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link " >Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/blog" class="menu-item-link active" >Blog</a>
        </li>
      
        <li class="menu-item">
          <a href="/ebook" class="menu-item-link " >Ebook</a>
        </li>
      
        <li class="menu-item">
          <a href="/music" class="menu-item-link " >Music</a>
        </li>
      
        <li class="menu-item">
          <a href="/album" class="menu-item-link " >Photo</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link " >About</a>
        </li>
      
    </ul>
  </nav>
</header>


<article class="post">
  <div class="post-title">
    <h1 class="article-title">Rust 和 OpenResty 的性能问题</h1>
  </div>
  <div class="post-content">
    <p>关于 rust 和 openresty 的一些问题</p>
<h2 id="问题引入"><a href="#问题引入" class="headerlink" title="问题引入"></a>问题引入</h2><p>最近要入职 DY 了，然后这边准备入职之后负责一个安全网关和WAF相关的一些事情。考虑到斗鱼这边使用openresty来实现WAF功能。我这边之前又在学习RUST，所以我来做一个测试，想测试一下用RUST来做一个安全网关的工作。看看能不能又一点的效果。</p>
<p>之前都是在用apache自带的ab做压力测试。后面考虑到性能测试的准确性，我于是用了wrk这个工具。</p>
<pre class="line-numbers language-none"><code class="language-none">git clone https:&#x2F;&#x2F;github.com&#x2F;wg&#x2F;wrk
cd wrk
make<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>编译之后在下面生成wrk的文件，可以通过一些参数测试。</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;wrk -t 4 -c 100 -d 10s --latency http:&#x2F;&#x2F;10.1.78.178:3001<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我这边用rust的hyper做了一个gateway的一个功能，主要是吧流量代理到0.0.0.0:8080上面，代码如下：</p>
<pre class="line-numbers language-none"><code class="language-none">#![deny(warnings)]

use hyper::service::&#123;make_service_fn, service_fn&#125;;
use hyper::&#123;Client, Error, Server&#125;;
use std::net::SocketAddr;

#[tokio::main]
async fn main() &#123;
    pretty_env_logger::init();

    let in_addr &#x3D; ([0, 0, 0, 0], 3001).into();
    let out_addr: SocketAddr &#x3D; ([0, 0, 0, 0], 8080).into();

    let client_main &#x3D; Client::new();

    let out_addr_clone &#x3D; out_addr.clone();

    &#x2F;&#x2F; The closure inside &#96;make_service_fn&#96; is run for each connection,
    &#x2F;&#x2F; creating a &#39;service&#39; to handle requests for that specific connection.
    let make_service &#x3D; make_service_fn(move |_| &#123;
        let client &#x3D; client_main.clone();

        async move &#123;
            &#x2F;&#x2F; This is the &#96;Service&#96; that will handle the connection.
            &#x2F;&#x2F; &#96;service_fn&#96; is a helper to convert a function that
            &#x2F;&#x2F; returns a Response into a &#96;Service&#96;.
            Ok::&lt;_, Error&gt;(service_fn(move |mut req| &#123;
                let uri_string &#x3D; format!(
                    &quot;http:&#x2F;&#x2F;&#123;&#125;&#123;&#125;&quot;,
                    out_addr_clone,
                    req.uri().path_and_query().map(|x| x.as_str()).unwrap_or(&quot;&quot;)
                );
                let uri &#x3D; uri_string.parse().unwrap();
                *req.uri_mut() &#x3D; uri;
                client.request(req)
            &#125;))
        &#125;
    &#125;);

    let server &#x3D; Server::bind(&amp;in_addr).serve(make_service);

    println!(&quot;Listening on http:&#x2F;&#x2F;&#123;&#125;&quot;, in_addr);
    println!(&quot;Proxying on http:&#x2F;&#x2F;&#123;&#125;&quot;, out_addr);

    if let Err(e) &#x3D; server.await &#123;
        eprintln!(&quot;server error: &#123;&#125;&quot;, e);
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后我用openresty的官方最新下载包，<a target="_blank" rel="noopener" href="https://openresty.org/cn/getting-started.html">安装编译</a>。然后编写相关的openresty的配置</p>
<pre class="line-numbers language-none"><code class="language-none">worker_processes  1;
error_log logs&#x2F;error.log;
events &#123;
    worker_connections 1024;
&#125;
http &#123;
    server &#123;
        listen 8081;
        location &#x2F;hello &#123;
            default_type text&#x2F;html;
            content_by_lua_block &#123;
                ngx.say(&quot;&lt;p&gt;hello, world&lt;&#x2F;p&gt;&quot;)
            &#125;
        &#125;

        location &#x2F; &#123;
            proxy_pass http:&#x2F;&#x2F;127.0.0.1:8080;
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里对流量进行了proxy_pass的代理到8080端口，然后我在8080后面用tornado启动了一个http服务。</p>
<h2 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h2><p>rust-hyper写的测试结果</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;wrk -t 4 -c 100 -d 10s --latency http:&#x2F;&#x2F;10.1.78.178:3001
Running 10s test @ http:&#x2F;&#x2F;10.1.78.178:3001
  4 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev
    Latency    48.49ms    3.14ms  82.11ms   87.34%
    Req&#x2F;Sec   517.28     53.08   696.00     82.50%
  Latency Distribution
     50%   47.98ms
     75%   49.70ms
     90%   51.35ms
     99%   62.28ms
  20600 requests in 10.03s, 5.01MB read
Requests&#x2F;sec:   2053.78
Transfer&#x2F;sec:    511.44KB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>openresty的测试结果</p>
<pre class="line-numbers language-none"><code class="language-none">.&#x2F;wrk -t 4 -c 100 -d 10s --latency http:&#x2F;&#x2F;10.1.78.178:8081
Running 10s test @ http:&#x2F;&#x2F;10.1.78.178:8081
  4 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +&#x2F;- Stdev
    Latency    60.43ms    3.96ms  74.39ms   85.46%
    Req&#x2F;Sec   414.72    103.06   505.00     75.00%
  Latency Distribution
     50%   59.69ms
     75%   61.90ms
     90%   65.07ms
     99%   71.96ms
  16525 requests in 10.03s, 4.38MB read
Requests&#x2F;sec:   1648.06
Transfer&#x2F;sec:    447.37KB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看出rust的性能还是比openresty要强的，这里还用的不是actix-web这个性能怪兽。然后在这里主要还是lua的拓展性比较强，但是我个人觉得其实rust在这块其实做的也不错。我会尝试用rust取构建一个安全网关。</p>

  </div>
  <div class="post-footer">
    

    <a href="#top" class="top">↑</a>
  </div>
</article>
<footer>
  &copy; 2024
  <span class="author">
    betta
  </span>
</footer>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/static/js/codeBlockFunction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/static/js/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/static/js/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/static/js/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
  </body>
</html>
