<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>lua-resty-mlcache 分析 - B</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=betta-cyber, game, betta, shokill>
  
    <meta name="description" content="betta">
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="B" type="application/atom+xml">
  

  

  

  <!-- <link rel="stylesheet" href="../css/style.css"> -->
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css">

  <!--  -->
    <!-- <link rel="stylesheet" href="../css/font-awesome.min.css"> -->
  <!--  -->

  <script src="/static/js/hexo_resize_image.js"></script>
  <script type="text/javascript" src="/static/js/jquery.min.js"></script>

  <script type='text/javascript' id='clustrmaps' src='//cdn.clustrmaps.com/map_v2.js?cl=ffffff&w=0&t=n&d=b9cDq33TdEsfGb_DpY--uB2pjskzQ8TK9LaE3yuIYzE&co=ffffff&cmo=ffffff&cmn=ffffff&ct=ffffff'></script>
<meta name="generator" content="Hexo 5.4.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <!-- <div class="blog-title">
    <a href="/" class="logo">B</a>
    <div class="subtitle"></div>
  </div> -->
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link " >Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/blog" class="menu-item-link active" >Blog</a>
        </li>
      
        <li class="menu-item">
          <a href="/ebook" class="menu-item-link " >Ebook</a>
        </li>
      
        <li class="menu-item">
          <a href="/music" class="menu-item-link " >Music</a>
        </li>
      
        <li class="menu-item">
          <a href="/album" class="menu-item-link " >Photo</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link " >About</a>
        </li>
      
    </ul>
  </nav>
</header>


<article class="post">
  <div class="post-title">
    <h1 class="article-title">lua-resty-mlcache 分析</h1>
  </div>
  <div class="post-content">
    <p>lua-resty-mlcache 用 shared dict 和 lua-resty-lrucache ，实现了多层缓存机制。</p>
<p>mlcache 的架构如下：</p>
<pre class="line-numbers language-none"><code class="language-none">┌─────────────────────────────────────────────────┐
│ Nginx                                           │
│       ┌───────────┐ ┌───────────┐ ┌───────────┐ │
│       │worker     │ │worker     │ │worker     │ │
│ L1    │           │ │           │ │           │ │
│       │ Lua cache │ │ Lua cache │ │ Lua cache │ │
│       └───────────┘ └───────────┘ └───────────┘ │
│             │             │             │       │
│             ▼             ▼             ▼       │
│       ┌───────────────────────────────────────┐ │
│       │                                       │ │
│ L2    │           lua_shared_dict             │ │
│       │                                       │ │
│       └───────────────────────────────────────┘ │
│                           │ mutex               │
│                           ▼                     │
│                  ┌──────────────────┐           │
│                  │     callback     │           │
│                  └────────┬─────────┘           │
└───────────────────────────┼─────────────────────┘
                            │
  L3                        │   I&#x2F;O fetch
                            ▼

                   Database, API, DNS, Disk, any I&#x2F;O...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>分为三层：</p>
<p>L1 层是使用 lua-resty-lrucache 的虚拟缓存。提供最快的查找。</p>
<p>L2 层是用的 Nginx 的 lua_shared_dict 内存共享。当 L1 层的 key miss 掉时，从这里获取。</p>
<p>L3 层提供一个自定义函数，有一个 Worker 执行，通过 lua-resty-lock 避免对后端的多次访问。L3 获取的值会被放到 L2 缓存当中。</p>
<p>用来做缓存的组件，shared dict 缓存和 lru 缓存。前者只能缓存字符串对象，缓存的数据有且只有一份，每一个 worker 都可以进行访问，所以常用于 worker 之间的数据通信。后者则可以缓存所有的 Lua 对象，但只能在单个 worker 进程内访问，有多少个 worker，就会有多少份缓存数据。</p>
<h2 id="缓存有两个原则"><a href="#缓存有两个原则" class="headerlink" title="缓存有两个原则"></a>缓存有两个原则</h2><p>一是越靠近用户的请求越好，比如能用本地缓存的就不要发送HTTP请求，能用CDN缓存的就不要打到web服务器，能用nginx缓存的就不要用数据库的缓存。</p>
<p>二是尽量使用本进程和本机的缓存解决，因为跨了进程和机器甚至机房，缓存的网络开销就会非常大，在高并发的时候会非常明显。</p>
<p>我们直接贴一下官方的示例</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># nginx.conf</span>

<span class="token directive"><span class="token keyword">http</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">lua_package_path</span> <span class="token string">"/path/to/lua-resty-mlcache/lib/?.lua;;"</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">lua_shared_dict</span> cache_dict <span class="token number">1m</span></span><span class="token punctuation">;</span>

    <span class="token directive"><span class="token keyword">init_by_lua_block</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">local</span> mlcache = require <span class="token string">"resty.mlcache"</span>

        local cache, err = mlcache.new(<span class="token string">"my_cache"</span>, <span class="token string">"cache_dict"</span>,</span> <span class="token punctuation">&#123;</span>
            lru_size = 500,    -- size of the L1 (Lua VM) cache
            ttl      = 3600,   -- 1h ttl for hits
            neg_ttl  = 30,     -- 30s ttl for misses
        <span class="token punctuation">&#125;</span>)
        if err then

        end

        _G.cache = cache
    <span class="token punctuation">&#125;</span>

    <span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">8080</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">content_by_lua_block</span></span> <span class="token punctuation">&#123;</span>
                <span class="token directive"><span class="token keyword">local</span> function callback(username)
                    return db:get_user(username) --</span> <span class="token punctuation">&#123;</span> name = "John Doe", email = "john@example.com" <span class="token punctuation">&#125;</span>
                end

                local user, err = cache:get("my_key", nil, callback, "John Doe")
                ngx.say(user.username) -- "John Doe"
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以上的示例很好了描述了整个程序运行的逻辑，在init阶段初始化缓存，然后用_G变量赋予全局变量，在使用阶段cache:get获取指定Key的缓存，缓存未命中就会调用L3，也就是callback方法。</p>
<h2 id="缓存风暴问题"><a href="#缓存风暴问题" class="headerlink" title="缓存风暴问题"></a>缓存风暴问题</h2><p>但这个示例中缺失了lua-resty-lock这个组件的调用，为了防止在L3阶段发现缓存风暴，所以把锁非常有必要。</p>
<p>将局部配置修改如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">lua_shared_dict cache_dict <span class="token number">1</span>m<span class="token punctuation">;</span>
lua_shared_dict cache_lock <span class="token number">1</span>m<span class="token punctuation">;</span>

init_by_lua_block <span class="token punctuation">&#123;</span>
    local mlcache <span class="token operator">=</span> require <span class="token string">"resty.mlcache"</span>

    local cache<span class="token punctuation">,</span> err <span class="token operator">=</span> mlcache<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"my_cache"</span><span class="token punctuation">,</span> <span class="token string">"cache_dict"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        lru_size <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span>    <span class="token operator">--</span> size of the <span class="token function">L1</span> <span class="token punctuation">(</span>Lua VM<span class="token punctuation">)</span> cache
        ttl      <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">,</span>   <span class="token operator">--</span> <span class="token number">1</span>h ttl <span class="token keyword">for</span> hits
        neg_ttl  <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span>     <span class="token operator">--</span> <span class="token number">30</span>s ttl <span class="token keyword">for</span> misses
        shm_locks <span class="token operator">=</span> <span class="token string">"cache_lock"</span><span class="token punctuation">,</span>
        resty_lock_opts <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            exptime <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
            timeout <span class="token operator">=</span> <span class="token number">5</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err then

    end
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="进程之间通讯问题"><a href="#进程之间通讯问题" class="headerlink" title="进程之间通讯问题"></a>进程之间通讯问题</h2><p>这个问题我们使用lua-resty-worker-events模块解决。</p>
<p>此模块提供了一种向Nginx服务器中的其他工作进程发送事件的方法。通信是通过一个共享的存储区进行的，事件数据将存储在该存储区中。</p>
<p>结合我们之前的缓存使用场景，在一个Worker中的缓存更新之后，要通知其他Worker也同步更新，它就发挥作用了。</p>
<p>我们看以下官方提供的示例</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">lua_shared_dict process_events <span class="token number">1</span>m<span class="token punctuation">;</span>

init_worker_by_lua_block <span class="token punctuation">&#123;</span>
    local ev <span class="token operator">=</span> require <span class="token string">"resty.worker.events"</span>

    local handler <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> event<span class="token punctuation">,</span> source<span class="token punctuation">,</span> pid<span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"received event; source="</span><span class="token punctuation">,</span>source<span class="token punctuation">,</span>
                <span class="token string">", event="</span><span class="token punctuation">,</span>event<span class="token punctuation">,</span>
                <span class="token string">", data="</span><span class="token punctuation">,</span> <span class="token function">tostring</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">", from process "</span><span class="token punctuation">,</span>pid<span class="token punctuation">)</span>
    end

    ev<span class="token punctuation">.</span><span class="token keyword">register</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>

    local ok<span class="token punctuation">,</span> err <span class="token operator">=</span> ev<span class="token punctuation">.</span>configure <span class="token punctuation">&#123;</span>
        shm <span class="token operator">=</span> <span class="token string">"process_events"</span><span class="token punctuation">,</span> <span class="token operator">--</span> defined by <span class="token string">"lua_shared_dict"</span>
        timeout <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>            <span class="token operator">--</span> life time of unique event data in shm
        interval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>           <span class="token operator">--</span> poll <span class="token function">interval</span> <span class="token punctuation">(</span>seconds<span class="token punctuation">)</span>

        wait_interval <span class="token operator">=</span> <span class="token number">0.010</span><span class="token punctuation">,</span>  <span class="token operator">--</span> wait before retry fetching event data
        wait_max <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">,</span>         <span class="token operator">--</span> max wait time before discarding event
        shm_retries <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">,</span>      <span class="token operator">--</span> retries <span class="token keyword">for</span> shm <span class="token function">fragmentation</span> <span class="token punctuation">(</span>no memory<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> not ok then
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"failed to start event system: "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    end
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在init_worker_by_lua_block阶段初始化，是因为它需要在每个Worker中都运行，便于同步到其他进程，其他的就是一些配置参数问题。</p>
<p>下面我们把它结合上面的缓存模块一起使用。</p>
<p>lua-resty-mlcache提供了ipc接口来支持lua-resty-worker-events模块，我们直接配置参数即可。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">lua_shared_dict cache_dict    <span class="token number">1</span>m<span class="token punctuation">;</span>
lua_shared_dict cache_lock    <span class="token number">1</span>m<span class="token punctuation">;</span>
lua_shared_dict worker_events <span class="token number">1</span>m<span class="token punctuation">;</span>

init_worker_by_lua_block <span class="token punctuation">&#123;</span>
    local mlcache <span class="token operator">=</span> require <span class="token string">"resty.mlcache"</span>
    local worker_events <span class="token operator">=</span> require <span class="token string">"resty.worker.events"</span>

    local ok<span class="token punctuation">,</span> err <span class="token operator">=</span> worker_events<span class="token punctuation">.</span>configure <span class="token punctuation">&#123;</span>
        shm <span class="token operator">=</span> <span class="token string">"worker_events"</span><span class="token punctuation">,</span>
        timeout <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
        interval <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>

        wait_interval <span class="token operator">=</span> <span class="token number">0.010</span><span class="token punctuation">,</span>
        wait_max <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">,</span>
        shm_retries <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>

    local cache<span class="token punctuation">,</span> err <span class="token operator">=</span> mlcache<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token string">"my_cache"</span><span class="token punctuation">,</span> <span class="token string">"cache_dict"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
        lru_size <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">,</span>    <span class="token operator">--</span> size of the <span class="token function">L1</span> <span class="token punctuation">(</span>Lua VM<span class="token punctuation">)</span> cache
        ttl      <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">,</span>   <span class="token operator">--</span> <span class="token number">1</span>h ttl <span class="token keyword">for</span> hits
        neg_ttl  <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span>     <span class="token operator">--</span> <span class="token number">30</span>s ttl <span class="token keyword">for</span> misses
        shm_locks <span class="token operator">=</span> <span class="token string">"cache_lock"</span><span class="token punctuation">,</span>
        resty_lock_opts <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            exptime <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
            timeout <span class="token operator">=</span> <span class="token number">5</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        ipc <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            register_listeners <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span>
                <span class="token keyword">for</span> _<span class="token punctuation">,</span> <span class="token class-name">event_t</span> in <span class="token function">pairs</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span> <span class="token keyword">do</span>
                    worker_events<span class="token punctuation">.</span><span class="token keyword">register</span><span class="token punctuation">(</span>
                        <span class="token function">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                            <span class="token class-name">event_t</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                        end<span class="token punctuation">,</span>
                        channel_name<span class="token punctuation">,</span>
                        <span class="token class-name">event_t</span><span class="token punctuation">.</span>channel
                    <span class="token punctuation">)</span>
                end
            end<span class="token punctuation">,</span>
            broadcast <span class="token operator">=</span> <span class="token function">function</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
                worker_events<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>channel_name<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
            end
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err then

    end
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

  </div>
  <div class="post-footer">
    

    <a href="#top" class="top">↑</a>
  </div>
</article>
<footer>
  &copy; 2024
  <span class="author">
    betta
  </span>
</footer>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/static/js/codeBlockFunction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/static/js/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/static/js/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/static/js/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
  </body>
</html>
