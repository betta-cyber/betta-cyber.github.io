<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>Fluentd 基础使用方式 - Skywalker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=betta-cyber, game, betta, shokill>
  
    <meta name="description" content="betta">
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="Skywalker" type="application/atom+xml">
  

  
  <!-- <link rel="stylesheet" href="../css/style.css"> -->
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <!-- <div class="blog-title">
    <a href="/" class="logo">Skywalker</a>
    <div class="subtitle"></div>
  </div> -->
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link " >Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/blog" class="menu-item-link active" >Blog</a>
        </li>
      
        <li class="menu-item">
          <a href="/ebook" class="menu-item-link " >Ebook</a>
        </li>
      
        <li class="menu-item">
          <a href="/music" class="menu-item-link " >Music</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link " >About</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">Fluentd 基础使用方式</h1>
  </div>
  <div class="post-content">
    <p>Fluentd 是一套开源数据搜集软体软件 (Data Collection Software)。通常在专案中我们会需要将各种资料传递到不同服务，如 Apache, MySQL, elasticsearch 等服务，但不同服务间的资料传递方式却各自不同，常会造成混乱。</p>
<p><img src="/article_photo/fluentd-before.png" alt="fluentd-before"></p>
<p>Fluentd 提供了统一的资料中介层 (Unified Logging Layer)，可将资料由不同来源汇入后，经过 Buffer 与资料处理后再将转抛到所设定的目的地，可大幅度降低系统间资料传递的复杂度。</p>
<p><img src="/article_photo/fluentd-architecture.png" alt="fluentd-architecture"></p>
<p>Fluentd 还包含以下特色</p>
<ul>
<li>由 C 与 Ruby 写成。</li>
<li>资料以 Json 格式搜集与转抛。</li>
<li>支援多重 Input&#x2F;Output 格式。</li>
<li>由多重 Plugin 组成，可自行加入非预设的功能。</li>
<li>透过设定档设定资料处理流程。</li>
</ul>
<h2 id="td-agent"><a href="#td-agent" class="headerlink" title="td-agent"></a>td-agent</h2><p>要使用 Fluentd 除了直接透过 Ruby Gem 安装外，也可安装 td-agent，由 Treasure Data 所维护的的发行版(The stable distribution of Fluentd)，因此之后的使用范例均用 td-agent。</p>
<h3 id="安装-td-agent-Ubuntu"><a href="#安装-td-agent-Ubuntu" class="headerlink" title="安装 td-agent (Ubuntu)"></a>安装 td-agent (Ubuntu)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## Ubuntu 16.04 (Xenial)</span><br><span class="line">curl -L https://toolbelt.treasuredata.com/sh/install-ubuntu-xenial-td-agent3.sh | sh</span><br><span class="line"></span><br><span class="line">## Ubuntu 18.04 (Bionic)</span><br><span class="line">curl -L https://toolbelt.treasuredata.com/sh/install-ubuntu-bionic-td-agent3.sh | sh</span><br></pre></td></tr></table></figure>

<h3 id="安裝-plugin"><a href="#安裝-plugin" class="headerlink" title="安裝 plugin"></a>安裝 plugin</h3><p>Fluentd 可透过安装外部 plugin 来扩充功能，可到 Fluentd 官网查询可安装列表，之后使用 td-agent-gem 指令来安装支援该服务的 plugin 到 td-agent 中。</p>
<p>如安装 elasticsearch 的 Fluentd plugin，可执行下列指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">td-agent-gem install fluent-plugin-elasticsearch</span><br></pre></td></tr></table></figure>

<h3 id="Fluentd-Config"><a href="#Fluentd-Config" class="headerlink" title="Fluentd Config"></a>Fluentd Config</h3><p>Fluentd 的资料接收，资料处理与资料导出的资料流处理流程都透过设定档来进行设定。而 td-agent 的设定档位于&#x2F;etc&#x2F;td-agent&#x2F;td-agent.conf。其中包含许多资料处理区间如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;source&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;match pattern&gt;</span><br><span class="line">  &lt;filter&gt;</span><br><span class="line">  ...</span><br><span class="line">  &lt;/filter&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/match&gt;</span><br></pre></td></tr></table></figure>

<p>该区间就是在定义 Fluentd 的资料来源与处理方式。不同区间代表不同的处理类型，如</p>
<ul>
<li>&lt;source&gt; - 资料输入(Input)来源设定</li>
<li>&lt;match pattern&gt; - 将 tag 符合 pattern 的资料输出(Output)到设定的目的地。</li>
<li>&lt;filter&gt;: 资料处理与过滤方式。</li>
</ul>
<p>还有其他如 <code>&lt;parse&gt;</code>，<code>&lt;format&gt;</code>，<code>&lt;buffer&gt;</code> 等处理区间。</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;source&gt;</span><br><span class="line">  @type http</span><br><span class="line">  port 9880</span><br><span class="line">&lt;/source&gt;</span><br><span class="line"></span><br><span class="line">&lt;match debug.**&gt;</span><br><span class="line">  @type stdout</span><br><span class="line">&lt;/match&gt;</span><br></pre></td></tr></table></figure>

<p>上面的设定 Fluentd 会接收来自 port 9880 的输入，并将 Tag 为 debug.* 的内容输出到标准输出。当透过指令输入</p>
<h3 id="Routing"><a href="#Routing" class="headerlink" title="Routing"></a>Routing</h3><p>由于 Fluentd 的资料流为 Top-down 的方式处理，也就是若之前已经使用 &lt;match pattern&gt; 撷取资料，在之后的段落是无法取得已经被撷取的资料，因此可以透过相关 plugin 对资料做 Routing 以分流处理。</p>
<h3 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h3><p><code>out_copy</code> plugin 可以复制资料流到不同的 &lt;match&gt; 区间中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;match park.log&gt;</span><br><span class="line">  @type copy</span><br><span class="line">  &lt;store&gt;</span><br><span class="line">    @type file</span><br><span class="line">    ...</span><br><span class="line">  &lt;/store&gt;</span><br><span class="line">  &lt;store&gt;</span><br><span class="line">    @type forward</span><br><span class="line">    ...</span><br><span class="line">  &lt;/store&gt;</span><br><span class="line">&lt;/match&gt;</span><br></pre></td></tr></table></figure>

<h3 id="relabel"><a href="#relabel" class="headerlink" title="relabel"></a>relabel</h3><p>通过 <code>out_relable</code> plugin，将资料标注新 label 并在外部处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;match park.log&gt;</span><br><span class="line">  @type copy</span><br><span class="line">  &lt;store&gt;</span><br><span class="line">    @type relabel</span><br><span class="line">    @label OUTPUT_FILE</span><br><span class="line">  &lt;/store&gt;</span><br><span class="line">  &lt;store&gt;</span><br><span class="line">    @type relabe</span><br><span class="line">    @label OUTPUT_FORWARD</span><br><span class="line">  &lt;/store&gt;</span><br><span class="line">&lt;/match&gt;</span><br><span class="line"></span><br><span class="line">&lt;label @OUTPUT_FILE&gt;</span><br><span class="line">  &lt;match park.log&gt;</span><br><span class="line">    @type file</span><br><span class="line">    ...</span><br><span class="line">  &lt;/match&gt;</span><br><span class="line">&lt;/label&gt;</span><br><span class="line"></span><br><span class="line">&lt;label @OUTPUT_FORWARD&gt;</span><br><span class="line">  &lt;match park.log&gt;</span><br><span class="line">    @type forward</span><br><span class="line">    ...</span><br><span class="line">  &lt;/match&gt;</span><br><span class="line">&lt;/label&gt;</span><br></pre></td></tr></table></figure>


<h3 id="测试-config-并重新启动服务"><a href="#测试-config-并重新启动服务" class="headerlink" title="测试 config 并重新启动服务"></a>测试 config 并重新启动服务</h3><p>当修改过 td-agent.conf 后可先测试该 config 设定是否可执行，只要在资料中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">td-agent --dry-run -c [config-file]</span><br></pre></td></tr></table></figure>


<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.fluentd.org/">Fluentd</a></li>
<li><a target="_blank" rel="noopener" href="https://www.fluentd.org/">Fluentd - Doc</a></li>
<li><a target="_blank" rel="noopener" href="https://www.fluentd.org/">Fluentd Bit</a></li>
</ul>

  </div>
  <div class="post-footer">
    

    <a href="#top" class="top">↑</a>
  </div>
</article>
<footer>
  &copy; 2023
  <span class="author">
    betta
  </span>
</footer>

    </div>
  </body>
</html>
