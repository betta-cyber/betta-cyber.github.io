<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>Rust 交叉编译及 CI/CD 相关 - Skywalker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=blog, game, betta>
  
    <meta name="description" content="betta">
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="Skywalker" type="application/atom+xml">
  

  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <!-- <div class="blog-title">
    <a href="/" class="logo">Skywalker</a>
    <div class="subtitle"></div>
  </div> -->
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/archives" class="menu-item-link">Blog</a>
        </li>
      
        <li class="menu-item">
          <a href="/ebook" class="menu-item-link">Ebook</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">About</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">Rust 交叉编译及 CI/CD 相关</h1>
  </div>
  <div class="post-content">
    <p>something about ci/cd</p>
<h2 id="问题由来"><a href="#问题由来" class="headerlink" title="问题由来"></a>问题由来</h2><p>由于涉及到rust交叉编译的问题，本人不太想折腾。主要是在不想在windows上安装rust相关。手头现在有一台macOS设备和一台linux服务器，想交叉编译到win上，于是做了一点尝试。MinGW应该是比较靠谱的方案。本人在mac上通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install FiloSottile&#x2F;musl-cross&#x2F;musl-cross</span><br><span class="line">brew install mingw-w64</span><br></pre></td></tr></table></figure>
<p>进行安装，但是网速慢，编译慢，等待时间较长，于是在安装的过程中开始探寻其他途径。ci/cd是一个方案。docker看起来也不错。在一番尝试之后，看起来github action对于rust windows的文档不是很全。于是选择travis进行测试。docker鉴于国内网络环境相关除非万不得已不然不太想尝试。</p>
<h2 id="travis相关"><a href="#travis相关" class="headerlink" title="travis相关"></a>travis相关</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">os: windows</span><br><span class="line">language: rust</span><br><span class="line">rust:</span><br><span class="line">- stable</span><br><span class="line">script:</span><br><span class="line">- cargo build --release --verbose</span><br><span class="line">- ls target&#x2F;release</span><br><span class="line">deploy:</span><br><span class="line">  api_key:</span><br><span class="line">    secure: xxxx</span><br><span class="line">  file_glob: true</span><br><span class="line">  file:</span><br><span class="line">    - &quot;target&#x2F;release&#x2F;gs.exe&quot;</span><br><span class="line">    - &quot;README.md&quot;</span><br><span class="line">  skip_cleanup: true</span><br><span class="line">  provider: releases</span><br><span class="line">  on:</span><br><span class="line">    tags: true</span><br></pre></td></tr></table></figure>

<p>上面是一份配置，简单说明一下，os表示操作系统，然后是rust和版本。再就是一些脚本，deploy会进行部署，这里provider选择releases，然后这里需要一个token。</p>
<p>首先通过 Ruby 的 gem 安装 travis</p>
<p><code>gem install travis</code></p>
<p>然后需要登录</p>
<p><code>travis login --pro</code></p>
<p>然后需要加密</p>
<p><code>travis encrypt SOMEVAR=&quot;secretvalue&quot;</code></p>
<p>生成出来的加密串放到<code>.travis.yml</code>中，就可以完成认证。</p>
<h2 id="GitHub-actions"><a href="#GitHub-actions" class="headerlink" title="GitHub actions"></a>GitHub actions</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">name: Continuous Integration</span><br><span class="line">on:</span><br><span class="line">  push:</span><br><span class="line">    branches:</span><br><span class="line">      - master</span><br><span class="line">  pull_request:</span><br><span class="line">    paths:</span><br><span class="line">      - &#39;**.rs&#39;</span><br><span class="line">      - &#39;Cargo.toml&#39;</span><br><span class="line">jobs:</span><br><span class="line">  build:</span><br><span class="line">    runs-on: ubuntu-latest</span><br><span class="line">    steps:</span><br><span class="line">    - uses: actions&#x2F;checkout@v1</span><br><span class="line">    - name: Build</span><br><span class="line">      run: |</span><br><span class="line">        sudo apt-get update</span><br><span class="line">        sudo apt-get -y install libasound2-dev libdbus-1-dev dbus</span><br><span class="line">        cargo test --verbose</span><br><span class="line">        cargo build --verbose</span><br></pre></td></tr></table></figure>

<p>这个例子就是一个action的ci例子。</p>
<h2 id="Rust-Windows-GNU-与-MinGW"><a href="#Rust-Windows-GNU-与-MinGW" class="headerlink" title="Rust Windows-GNU 与 MinGW"></a>Rust Windows-GNU 与 MinGW</h2><p>2月5号更新，鉴于travis生成的exe文件在win10上面不能成功运行，且trace看不出什么究竟，故而选择在macOS上面交叉编译，macOS上面由于rust官方toolchains的lib中crt2.o较老，会出现一些<code>undefined reference to &#39;__imp___acrt_iob_func&#39;</code>类似的报错，需要手动进行替换。<br>在<code>~/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/x86_64-pc-windows-gnu/lib</code>目录下，也就是你的rust版本的lib下，进行备份，然后将通过brew安装的mingw-w64下的lib crt2进行替换。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv crt2.o crt2.o.bak</span><br><span class="line">cp &#x2F;System&#x2F;Volumes&#x2F;Data&#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;mingw-w64&#x2F;7.0.0&#x2F;toolchain-x86_64&#x2F;x86_64-w64-mingw32&#x2F;lib&#x2F;crt2.o .&#x2F;</span><br></pre></td></tr></table></figure>

<p>替换之后可以进行正常编译，通过指定target <code>cargo build --release --target x86_64-pc-windows-gnu</code> 将编译出相应的exe，但是对于webview的example例子，编译之后的文件还是无法在win10上面运行。最基本的rust helloworld程序却是可以的，这说明其实我mac上面交叉编译其实这条路是走通了，但是对于rust的webview这个库其实还是有点问题。但是查了相关issuse，并没有发现这样的问题，于是决定在win10上面进行问题排查。</p>
<p>于是只好选择在windows上面安装rust，通过rustup安装，设置相关中国源，安装成功后，由于Rust使用的链接器是系统提供的，而且Rust的标准库也对libc有依赖。在Linux/Mac等环境下，Rust会使用gcc执行链接。在Windows下，系统没有原生自带链接器。主流的免费C/C++工具链主要有五套，分别是Visual C++、Clang、Mingw-w64 GCC、MSYS2 GCC、CYGWIN GCC。</p>
<p>通过 <code>rustup target list</code> 可以看到Rust 在Windows下的编译支持主要是两种，分别对应列表里的Visual C++ 和 Mingw-w64 GCC 两种，分别称作msvc 和 gnu 的target，同时有对应的toolchain。msvc的情况在这里不细说了。下面主要说下gnu。</p>
<p>本人在安装默认选择<code>x86_64-pc-windows-gnu</code>，rustup会自行安装rust-mingw，但是rust捆绑的mingw运行时版本要旧于现在很多MinGW运行时版本。导致我的项目clone下来，无法直接编译成功。一直提示不支持64位操作系统。现在想来应该是Babun自带的gcc是32位的导致我一直编译不通过。一开始我还没发现这个问题，索性一不做二不休，直接上MinGW-w64，MinGW-w64也有很多种.在windows上运行的版本，提供的有几家，比较官方的是mingw-w64-builds(MinGW-builds)，另外还有msys2(MSYS2 homepage)、win-builds(<a href="http://win-builds.org)等等。我这里选择的是官方的途径安装。不建议在线安装，通过下载离线版方式，并写入环境变量。" target="_blank" rel="noopener">http://win-builds.org)等等。我这里选择的是官方的途径安装。不建议在线安装，通过下载离线版方式，并写入环境变量。</a></p>
<p>然后就是进行替换。</p>
<ul>
<li>移除rust-mingw</li>
<li>告诉rust使用自己安装的mingw。</li>
<li>替换crt2.o 和 dllcrt2.o。</li>
</ul>
<p>1.执行<code>rustup component remove rust-mingw</code></p>
<p>2.添加配置到cargo的config当中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[target.x86_64-pc-windows-gnu]</span><br><span class="line">linker &#x3D; &quot;C:\\mingw64\\bin\\gcc.exe&quot;</span><br><span class="line">ar &#x3D; &quot;C:\\mingw64\\bin\\ar.exe&quot;</span><br></pre></td></tr></table></figure>
<p>3.和macOS上面替换是一样的原理。</p>
<p>现在就可以编译成功了。</p>
<p>ps. windows上还是自己安装一个MinGW，配置好然后应用到cargo上，省事。</p>

  </div>
  <div id="comments"></div>
  <div class="post-footer">
    

    <a href="#top" class="top">Back to Top</a>
  </div>
</article>
<footer>
  &copy; 2021
  <span class="author">
    betta-cyber
  </span>
</footer>

<link rel="stylesheet" href="https://billts.site/extra_css/gitment.css">
<script src="https://billts.site/js/gitment.js"></script>
<script>
const gitment = new Gitment({
  id: 'Tue Feb 04 2020 01:13:14 GMT+0000',
  owner: 'betta-cyber',
  repo: 'betta-cyber.github.io',
  oauth: {
    client_id: 'e32a2371d055a4a6872f',
    client_secret: '8b5c050a8fffd9ed254c421080cf55d7ae55f266',
  },
})

gitment.render('comments')
</script>

    </div>
  </body>
</html>
