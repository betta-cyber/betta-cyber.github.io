<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>Rust 交叉编译及 CI/CD 相关 - Skywalker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=betta-cyber, game, betta, shokill>
  
    <meta name="description" content="betta">
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.02">
  
  
    <link rel="alternate" href="/atom.xml " title="Skywalker" type="application/atom+xml">
  

  
  <!-- <link rel="stylesheet" href="../css/style.css"> -->
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.1"></head>

  <body>
    <div class="container">
      <header class="header">
  <!-- <div class="blog-title">
    <a href="/" class="logo">Skywalker</a>
    <div class="subtitle"></div>
  </div> -->
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link " >Home</a>
        </li>
      
        <li class="menu-item">
          <a href="/archives" class="menu-item-link active" >Blog</a>
        </li>
      
        <li class="menu-item">
          <a href="/album" class="menu-item-link " >Photo</a>
        </li>
      
        <li class="menu-item">
          <a href="/ebook" class="menu-item-link " >Ebook</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link " >About</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">Rust 交叉编译及 CI/CD 相关</h1>
  </div>
  <div class="post-content">
    <h2 id="问题由来"><a href="#问题由来" class="headerlink" title="问题由来"></a>问题由来</h2><p>由于涉及到 Rust 交叉编译的问题，本人不太想折腾。主要是在不想在 Windows 上安装 Rust 相关。手头现在有一台 MacOS 设备和一台 Linux 服务器，想交叉编译到 Win 上，于是做了一点尝试。MinGW 应该是比较靠谱的方案。本人在 Mac 上通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install FiloSottile/musl-cross/musl-cross</span><br><span class="line">brew install mingw-w64</span><br></pre></td></tr></table></figure>
<p>进行安装，但是网速慢，编译慢，等待时间较长，于是在安装的过程中开始探寻其他途径。CI&#x2F;CD 是一个方案。Docker 看起来也不错。在一番尝试之后，看起来 GitHub action 对于 Rust Windows 的文档不是很全。于是选择 Travis 进行测试。Docker 鉴于国内网络环境相关除非万不得已不然不太想尝试。</p>
<h2 id="travis-相关"><a href="#travis-相关" class="headerlink" title="travis 相关"></a>travis 相关</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">os: windows</span><br><span class="line">language: rust</span><br><span class="line">rust:</span><br><span class="line">- stable</span><br><span class="line">script:</span><br><span class="line">- cargo build --release --verbose</span><br><span class="line">- ls target/release</span><br><span class="line">deploy:</span><br><span class="line">  api_key:</span><br><span class="line">    secure: xxxx</span><br><span class="line">  file_glob: true</span><br><span class="line">  file:</span><br><span class="line">    - &quot;target/release/gs.exe&quot;</span><br><span class="line">    - &quot;README.md&quot;</span><br><span class="line">  skip_cleanup: true</span><br><span class="line">  provider: releases</span><br><span class="line">  on:</span><br><span class="line">    tags: true</span><br></pre></td></tr></table></figure>

<p>上面是一份配置，简单说明一下，os 表示操作系统，然后是 rust 和版本。再就是一些脚本，deploy 会进行部署，这里 provider 选择 releases，然后这里需要一个 token。</p>
<p>首先通过 Ruby 的 gem 安装 travis</p>
<p><code>gem install travis</code></p>
<p>然后需要登录</p>
<p><code>travis login --pro</code></p>
<p>然后需要加密</p>
<p><code>travis encrypt SOMEVAR=&quot;secretvalue&quot;</code>生成出来的加密串放到<code>.travis.yml</code> 中，就可以完成认证。</p>
<h2 id="GitHub-actions"><a href="#GitHub-actions" class="headerlink" title="GitHub actions"></a>GitHub actions</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">name: Continuous Integration</span><br><span class="line">on:</span><br><span class="line">  push:</span><br><span class="line">    branches:</span><br><span class="line">      - master</span><br><span class="line">  pull_request:</span><br><span class="line">    paths:</span><br><span class="line">      - &#x27;**.rs&#x27;</span><br><span class="line">      - &#x27;Cargo.toml&#x27;</span><br><span class="line">jobs:</span><br><span class="line">  build:</span><br><span class="line">    runs-on: ubuntu-latest</span><br><span class="line">    steps:</span><br><span class="line">    - uses: actions/checkout@v1</span><br><span class="line">    - name: Build</span><br><span class="line">      run: |</span><br><span class="line">        sudo apt-get update</span><br><span class="line">        sudo apt-get -y install libasound2-dev libdbus-1-dev dbus</span><br><span class="line">        cargo test --verbose</span><br><span class="line">        cargo build --verbose</span><br></pre></td></tr></table></figure>

<p>这个例子就是一个 action 的 ci 例子。</p>
<h2 id="Rust-Windows-GNU-与-MinGW"><a href="#Rust-Windows-GNU-与-MinGW" class="headerlink" title="Rust Windows-GNU 与 MinGW"></a>Rust Windows-GNU 与 MinGW</h2><p>2 月 5 号更新，鉴于 travis 生成的 exe 文件在 win10 上面不能成功运行，且 trace 看不出什么究竟，故而选择在 macOS 上面交叉编译，macOS 上面由于 rust 官方 toolchains 的 lib 中 crt2.o 较老，会出现一些 <code>undefined reference to &#39;__imp___acrt_iob_func&#39;</code> 类似的报错，需要手动进行替换。<br>在 <code>~/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/x86_64-pc-windows-gnu/lib</code> 目录下，也就是你的 rust 版本的 lib 下，进行备份，然后将通过 brew 安装的 mingw-w64 下的 lib crt2 进行替换。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv crt2.o crt2.o.bak</span><br><span class="line">cp /System/Volumes/Data/usr/local/Cellar/mingw-w64/7.0.0/toolchain-x86_64/x86_64-w64-mingw32/lib/crt2.o ./</span><br></pre></td></tr></table></figure>

<p>替换之后可以进行正常编译，通过指定 target<code>cargo build --release --target x86_64-pc-windows-gnu</code> 将编译出相应的 exe，但是对于 webview 的 example 例子，编译之后的文件还是无法在 win10 上面运行。最基本的 rust helloworld 程序却是可以的，这说明其实我 mac 上面交叉编译其实这条路是走通了，但是对于 rust 的 webview 这个库其实还是有点问题。但是查了相关 issuse，并没有发现这样的问题，于是决定在 win10 上面进行问题排查。</p>
<p>于是只好选择在 windows 上面安装 rust，通过 rustup 安装，设置相关中国源，安装成功后，由于 Rust 使用的链接器是系统提供的，而且 Rust 的标准库也对 libc 有依赖。在 Linux&#x2F;Mac 等环境下，Rust 会使用 gcc 执行链接。在 Windows 下，系统没有原生自带链接器。主流的免费 C&#x2F;C++ 工具链主要有五套，分别是 Visual C++、Clang、Mingw-w64 GCC、MSYS2 GCC、CYGWIN GCC。</p>
<p>通过 <code>rustup target list</code> 可以看到 Rust 在 Windows 下的编译支持主要是两种，分别对应列表里的 Visual C++ 和 Mingw-w64 GCC 两种，分别称作 msvc 和 gnu 的 target，同时有对应的 toolchain。msvc 的情况在这里不细说了。下面主要说下 gnu。</p>
<p>本人在安装默认选择 <code>x86_64-pc-windows-gnu</code>，rustup 会自行安装 rust-mingw，但是 rust 捆绑的 mingw 运行时版本要旧于现在很多 MinGW 运行时版本。导致我的项目 clone 下来，无法直接编译成功。一直提示不支持 64 位操作系统。现在想来应该是 Babun 自带的 gcc 是 32 位的导致我一直编译不通过。一开始我还没发现这个问题，索性一不做二不休，直接上 MinGW-w64，MinGW-w64 也有很多种。在 windows 上运行的版本，提供的有几家，比较官方的是 mingw-w64-builds (MinGW-builds)，另外还有 msys2 (MSYS2 homepage)、win-builds (<a target="_blank" rel="noopener" href="http://win-builds.org/">http://win-builds.org</a>) 等等。我这里选择的是官方的途径安装。不建议在线安装，通过下载离线版方式，并写入环境变量。</p>
<p>然后就是进行替换。</p>
<ul>
<li>移除 rust-mingw</li>
<li>告诉 rust 使用自己安装的 mingw。</li>
<li>替换 crt2.o 和 dllcrt2.o。</li>
</ul>
<ol>
<li>执行 <code>rustup component remove rust-mingw</code></li>
<li>添加配置到 cargo 的 config 当中<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[target.x86_64-pc-windows-gnu]</span><br><span class="line">linker = &quot;C:\\mingw64\\bin\\gcc.exe&quot;</span><br><span class="line">ar = &quot;C:\\mingw64\\bin\\ar.exe&quot;</span><br></pre></td></tr></table></figure></li>
<li>和 macOS 上面替换是一样的原理。</li>
</ol>
<p>现在就可以编译成功了。</p>
<p>ps. Windows 上还是自己安装一个 MinGW，配置好然后应用到 cargo 上，省事。</p>

  </div>
  <div class="post-footer">
    

    <a href="#top" class="top">↑</a>
  </div>
</article>
<footer>
  &copy; 2022
  <span class="author">
    betta
  </span>
</footer>

    </div>
  </body>
</html>
