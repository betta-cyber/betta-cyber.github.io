---
title: 当我们在下载时，我们在想些什么？
abbrlink: 68587c61
date: 2022-06-14 09:00:00
---

## 引言

曾经有一种从 IE 缓存目录提取缓存数据然后重命名就可以下载各种在线音频和视频的方法。

🖥这种方法侧面证明了浏览互联网内容即是一个不断下载文件的过程。

😋我们每时每刻都在download。

所以，当我们在下载的时候，我们在想些什么🧐？

## 从下载的几种方式开始讲起

### 最基础的下载方式 —— HTTP(S)

`http://dldir1.qq.com/qqfile/qq/TIM2.0.0/22317/TIM2.0.0.exe` 这个链接看起来很熟悉是吗？当下载提示弹出来的一刻，你有没有认识到这种最直接最为人熟知也是最多人使用的下载方式，和访问网页这一行为之间的区别？

答案是没有区别。

HTTP 制定了双方该怎么说，用什么方式让对方听到，碰到各种情况如何回应。浏览器和服务器都遵守这个规矩，可以避免出现「鸡同鸭讲」的问题。

这里的首页数据就是很多个不同格式的文件。之所以我们会常识性地把浏览网页和下载文件区分开，是因为浏览器里面内置了可以将这些数据视觉化的解释引擎「简单理解：解码器」，当首页数据文件下载完毕时立即渲染出可以直接「看」的网页；而一些它「读不懂」的数据，则会提示你保存到设备让其他可以「读懂」的程序打开它。

优点:
- 不需要专用的下载工具。使用普通浏览器甚至不需要浏览器都可以随时随地保存文件。例如我们平时打开需要联网的 App 时获取的数据，就是通过 http 「下载」到本地之后再进行解析。
- 文件名，格式和下载域名直接可见，可以一定程度避免下载到错误的文件。
- 轻松达到满速。在服务器带宽足够或有好的 CDN 情况下下载速度可以轻松达到物理宽带满速。这里的「带宽」指的是一秒钟能传输的最大信息量，并非实际的速度。单位是 Mbps（Mega bit per second），例如运营商说的 100M（兆）光纤就是 100Mbps 的光纤，注意单位是「bit（位）」。我们常说的下载速度是 MB/s（Mega Byte per second），注意单位是「Byte（字节）」。虽然缩写相同，但是它们是完全不同的单位，关系是 1Byte=8bit，也就是说 100M 光纤理论上能达到的最大下载速度就是 100/8=12.5MB/s。
那么为什么要用两个单位呢？这是因为数据传输的最小单位是 bit，也就是二进制中的 0 或者 1，而文件储存的最低单位是 Byte，由 8 个 bit 组成，根据排列不同有 2 的 8 次方即 256 种排列方法，可以代表包括数字，大小写字母和常用字符。（这也是为啥 1Byte=8bit，同理一个中文字占 2 byte，因为 2 的 16 次方等于 65536，16bit 才足够覆盖常见中文字符）
所以数据传输领域经常用 bit 做单位（传输的是 0/1），下载和上传速度用 Byte 做单位（因为下载或上传 1byte 以上的数据才有意义）。
CDN（Content Delivery Network，内容分发网络），是为了解决网络延时，响应速度和稳定率的一种技术。假设某个网站只有在上海有服务器，那么上海的用户访问网站就比需要经过多个运营商节点跳转的云南用户快上不少。

这时候网站购买了 CDN 服务，在空闲时将网站访问量大的数据复制到覆盖全国的多个服务器上，用户访问网站时自动调用最近的 CDN 服务器上的网站数据，不会再因为距离过远导致数据加载速度降低。既提高了用户体验，又实现了负载均衡和数据备份，现在大部分网站和游戏都部署了 CDN。

#### 断点续传与多线程下载加速的原理

说到 HTTP 下载，那不得不提到一些现在或者曾经非常好用的 HTTP 下载器，比如 Windows 上老牌的 IDM，活在人们心中的网络蚂蚁和网际快车，被誉为手机版 IDM 的 ADM 等。它们之所以受到人们的喜爱与称赞，是因为它们提供了曾经是杀手锏级别的两个功能 —— 断点续传与多线程下载，这两个功能节省了大家巨量的下载时间，但是你知道这两个功能是怎样工作的吗？

#### 断点续传的原理

断点续传的原理其实非常简单。我们平时下载的文件，无论是 MP3，FLV 还是其他随便什么格式，服务器都是采用流（Stream）的方式传到我们的本地设备上。就像往杯里倒水一样，不管是橙汁还是牛奶都是一样地从瓶里流到杯里，带宽即相当于瓶口的宽度，决定你能倒多快。

以一个 1MB 的文件为例，当你下载了 512KB 然后按下暂停下载按钮的时候，什么也不会发生。只有在你下次继续下载的时候，支持断点续传的客户端才会以字节数的方式直接在请求头（Header，每次请求就像寄信，Header 就像是信封上的信息，包含双方地址身份信息和其他自定义信息）告诉服务器我需要从第 512000 字节开始下载，支持断点下载的服务器（现在不支持这个的服务器已经濒临灭绝了……）就会从 512000 字节开始传输流并返回一个表示「这是续传」的特殊状态码 206（状态码用来表示目标服务器或者域名解析服务器对这个请求的「态度」，像是我们常见的 404 就是表示「我不存在」的状态码）以说明这个不是重新下载的流。

到这里断点续传还要解决一个问题，就是当暂停下载文件之后，服务器上的文件被修改了，如果接着下载的话最后文件数据肯定是错的。所以支持断点续传的客户端在请求续传时，除了告诉服务器已经下载的大小，还会告诉服务器这个文件在上次暂停时最后修改的时间（服务器文件在这之后修改过的话时间就对不上了）或者整个文件的文件指纹（由文件大小和内容计算得出，就像指纹一样，内容不同的文件不会有一样的指纹）。

服务器比较之后决定是续传还是从头开始传输文件流给客户端，为了避免服务器端重新传输文件流而客户端认为是续传的文件流，从头开始下载的时候服务器会返回另一个表示「我很正常」状态码（200）。用 200、206 两个状态码即可保证客户端和服务器不会误解对方。

#### 多线程下载加速的原理

多线程下载其实是利用断点续传的一个机智技巧，在说明为什么之前我们来做道简单的数学题（为方便理解设定 1M 带宽等于 1M/s 下载速度，实际下载速度应为 1/8 左右，同时所有人都有比下载速度高的带宽）。

一般的服务器（除去那些故意限制用户速度的）是通过同时下载的线程数平均分配下载带宽，假设一个服务器上的某个文件最高享有 100M 的带宽，同时有 50 个线程下载的时候每个线程分到的下载速度即是 2m/s。可是单纯的服务器认为一个人只能用一个线程来下载，怎想到其中 10 个线程都是同一个人用多线程下载器请求的，那这个人分到了多少下载速度？
20M/s！知道多线程下载为什么能够提升下载速度了吧，那么多线程实际上是怎样「欺骗」服务器的呢？答案是利用断点续传，简单来讲，一个 10 线程的下载器在接到下载一个文件的请求之后：
- 首先做的就是向服务器请求这个文件的大小然后切成 10 份。
- 接着每一个线程假装断点续传，分别在请求下载的请求头中告诉服务器我要从 1/10，2/10，3/10…9/10 开始下载，服务器天真地以为这真的是一个断点续传的请求于是便从这个线程要求的地方开始传输文件流。
- 只需要 1/10 时间（完美情况下）文件已经下载完毕，下载器再在本地把这十块文件拼起来，一次机智的多线程下载就这样子完成啦。
多线程另外一个可以加快下载速度的原因是 TCP（Transmission Control Protocol 传输控制协议，HTTP 客户端与服务器传输数据的方法）设计之初非常为他人着想，能用少带宽办到的事情绝对不会申请更多的带宽，尽量留给其他人更多的带宽。这对于互联网环境当然是好事，但对于下载者来讲「舍己为人」可不行，于是人们开始利用多线程打破这个限制。


### 专为传输文件的下载方式 —— FTP
ftp:// 开头的链接相信大家都见过，也下载过，感觉上和 HTTP 下载没有什么两样。那么你知道它和 HTTP 的区别吗？

要说他俩，那就要详细说一下前面提到的它俩的母亲 —— TCP 协议。

TCP 协议和我们熟悉的 IP 一起组成的 TCP/IP 协议族是互联网的基础，TCP 定义了数据如何传输，IP 定义了如何联系互联网上的设备。HTTP，FTP 和其他协议都是从它们身上延伸出来的，可以说 HTTP 和 FTP 是亲兄弟。

不过大哥可不是 HTTP。在 1991 年年轻的 HTTP0.9 初出茅庐然后华丽丽地被无视之前，FTP 已经活跃了十几年，事实上 FTP（1971） 比 HTTP（1989） 的诞生早了 18 年左右，甚至比现在定义的互联网出现的还要早！

大家知道互联网并不是世界上最早的网络吗？互联网的祖先 —— ARPAnet（Advanced Research Projects Agency Network，高等研究计划署网络，音译阿帕网）才是真正的始祖。这个网络采用的通信协议是 NCP（Network Control Program，网络控制程式），那个时候 TCP/IP 和 HTTP 还没影，基于 NCP 的 FTP 就已经出现了，作为阿帕网中计算机之间传输文件的协议。后来阿帕网逐渐变成互联网，NCP 也变成了 TCP/IP，FTP 才把底层协议换成 TCP。所以说，FTP 才是当之无愧的大哥。

虽然 HTTP 和 FTP 都是同一个协议拓展出来的，不过亲兄弟不一定是双胞胎。HTTP 多是针对为客户端提供文件传输；FTP 则是为了在特定主机之间相互传输文件而开发的标准（互联网出现之前还没有浏览器这种客户端）。

由于涉及到双向传输数据，因此在连接 FTP 服务器的时候我们必须通过用户名和密码认证自己的身份。

那为什么我们通过 FTP 下载的时候不用输入用户名和密码呢？因为密码是可选的，只要服务器以 Anonymous（中文：匿名）作为用户名，那么它储存的文件任何人都可以访问。

除了结构上有所不同以外，在下载时 HTTP 和 FTP 的方便性和下载时间是一模一样的，这意味着它们的优缺点也差不多。FTP 主要是一些需要在服务器上同时储存和交换大量文件的站点在使用，像是大名鼎鼎的电影天堂就以 FTP 作为下载他们电影的唯一方式：

`ftp://ygdy8:ygdy8@yg45.dydytt.net:7080/[\*\*\*\*][English][1080p]AAAAA.mkv`

附上 FTP 链接的结构解释：

ftp://[用户名:口令@]ftp服务器域名或IP:[端口号]/文件路径/文件名。

另外，在很多部电影特别是特工电影中都出现过 FTP 的身影，比如 Netflix 2017 年的电影《王牌保镖》（Hitman’s Bodyguard）第 98 分钟就出现了登录 FTP 输入密码的全过程。感兴趣的朋友可以看下这部电影。

匿名 FTP 的特性还受到各个字幕组和游戏破解组的青睐，像是大名鼎鼎的游戏破解组 CPY 就是通过 FTP 发布新的破解游戏。


### 进阶下载，从半中心化到完全去中心化

#### 什么是下载中心化？什么是下载去中心化?

顾名思义，中心化的核心是中心——在下载中指的是储存着文件数据的一个或者确定数量的服务器，中心化意味着只有特定的储存着文件数据的服务器没有关闭并且开放数据，用户才能获取到它所储存的文件数据，一旦服务器遭遇不可抗力挂掉或者它的的所有者关闭对外开放的下载端口，我们就没办法再下载上面的东西。

中心化在文件下载时的缺陷再明显不过，加上基础下载方式的种种缺点，早期顶着拨号上网龟速的网民们在下载文件（特别是大文件）的时候往往是提心吊胆的，生怕突然就弹出一个下载失败的框框。最可怕的是，有时候下载失败的文件需要重新下载而不是继续下载。

#### eD2k 下载
说到 eD2k（全写：eDonkey2000 Network） 国人最熟悉的莫过于电驴（英语：VeryCD）了吧，不过与大家想象中的巨量文件不同，电驴整个站只储存了文件的 eD2k 链接（整个电驴储存的文件链接填入 TXT 可能就几十 MB） ，那么它是如何 24\*7 不间断提供巨量资源下载的呢？这要从 eD2k 网络的原理讲起。
严格来讲 eD2k 并不是文件下载协议而是文件共享协议，用户在使用 eD2k 客户端的时候必须在本地设置一个共享目录和公网端口，所有放在共享目录里的文件都可以被其他 eD2k 用户检测并读取。
只要用户数量足够多，并且每一个用户都自觉将文件放到共享目录里面分享出去，作为一个小小的下载源。这样子所有用户就能组成一个全面又实时保持更新迭代的超巨型下载服务器。像是电驴这种服务器只是提供获取文件的方法，也就是文件链接，所有文件都是由独立的用户分享的。
eD2k 还支持通过文件指纹将不同文件名的同一文件成功识别为一个文件，并把大文件「>= 9.28 MB」切成一个个小小的文件块，当同一个文件有多个人共享的时候就会同时从每一处提取不同的文件块，达到加速下载的效果。

`ed2k://|file|eMule0.5c.zip|2868871|0F88EEFA9D8AD3F43DABAC9982D2450C|/`

它的结构简单清晰：

`ed2k://|file|<文件名>|<文件大小>|<文件指纹>|/`

每一个共享目录里面的文件都会生成一个像这样子的链接（一般还会包含本机的地址），当别人在客户端打开这条链接或者在文件站点（如电驴）里面搜索 eMule0.5c.zip 这个文件名时，所有文件指纹为 0F88EEFA9D8AD3F43DABAC9982D2450C 的共享文件都会提供下载数据，从而实现去中心化的下载。
实际上最早的 eD2k 网络也是需要中心服务器来实现用户间的通讯，eD2k 在这个阶段只能说是半中心化，同时 eD2k 还深受钓鱼服务器的困扰，直到后来新的 eMule（中文：电骡）客户端支持 KAD 网络之后才实现完全去中心化。

很多人可能就有问题了，为什么我在用迅雷/旋风下载 eD2k 文件的时候不用设置共享目录呢？这就涉及到一个名为「吸血驴」的违反互联网精神的行为。简单来讲，就是「又想马儿跑，又想马儿不吃草」，这些客户端利用 eD2k 的优点吸引用户，又不能因为 eD2k 麻烦的配置和对上传速度的要求吓跑用户，所以很狡猾地利用各种伪装方法从 eD2k 网络下载文件但是一丁点儿数据都不会共享给 eD2k 网络。

这种方法显然是非常不道德的。试想一下当用「吸血驴」客户端的人越来越多，那么实际提供文件的用户会越来越少，也就是说能下的东西越来越少，能下的东西越少就越少人用，构成一个恶性循环。事实上吸血驴也是 eD2k 没落的重要原因。

#### BT

BT，种子，磁力链接，magnet:?xt=，相信每一个经常下载文件的人看到这些名词都会眼前一亮。没错，这些词都属于我们在使用 BT（BitTorrent，种子）下载时频繁碰到的单词，基本上已经达到了习以为常的程度。

##### 从种子文件理解 BitTorrent 协议

说到 BT 就不得不说扩展名为 .torrent 的种子文件（英语：Torrent file），因为必须有种子文件才可以下载到对应的 BT 资源。那平时老听到有人说留种的时候，到底留的是什么呢？

留的是 Tracker 信息和文件信息。

为了方便理解，我们以一部虚构电影的种子 [Fairyex][Batman][01][2160P][HEVC_Ma10P][MKV].torrent 为例。

当用记事本或者其他文本浏览器打开这个种子文件，看到的是一大串类似于链接的字符串，后面跟着的是谁都看不懂的乱码

Tracker 信息

蓝色的链接即为这个种子自带的下载中需要用到的 Tracker 服务器的地址和针对 Tracker 服务器的设置，Tracker 服务器的作用就是提供给下载者已经下载或者正在下载少数派大电影的其他下载者的地址信息，方便下载者与其他下载者连接。

种子内置了 Tracker 的好处就在于如果大家都是用这个种子下载的少数派大电影，后来下载的人可以直接通过这几个 Tracker 和正在下载或拥有这个文件的人连接。
文件信息
在 Track 服务器之后我们还能看到一段不是乱码的字符，这里和后面的乱码一起组成了需要下载的文件信息。
先简单说一下常见的文件基础信息，信息以冒号分割：

- creation date: 种子创建日期，是从1970年1月1日00:00:00到现在的秒数。
- encoding: 种子文本编码，一般都是 UTF-8。
- name: 显而易见 [The Big Story Of SSpai][01][2160P][HEVC\_Ma10P].mkv 是我们要下载的文件名。
- Pieces: 文件被分成了多少块（可以看到这里分为了 32240 块）。
- piece length: 每块文件的大小。
- files 与 path: 如果种子文件中有多个文件或文件夹，这两个关键字就是用来展示它们的。

小知识：种子文件里面也可以包含 eD2k 信息。

剩下的乱码即是 BT 生成的每一块切好的文件块的指纹，在下载少数派大电影的时候每下载一块（这里是 1/32240）下载器会对比种子里的指纹和下载数据是不是匹配的，这样子可以确保下载时数据的准确性。即使是出错，需要重下的也只是出错的那小小的一部分（1/32240）。


### 有潜力的下载方式：Metalink，UDP 与 PT

#### Metalink

我们先从最简单的 Metalink 开始，与 BT 和 eD2K 等下载协议不同，Metalink 是一个非常简单易懂的下载标准。简单描述就是 Metalink 文件储存了可以下载一个或多个文件的多种下载方式的多个地址，相当于让你可以同时用不同的下载方式下载同一个或多个文件。

以少数派大电影的 Metalink4.0 文件 Fairyex01HEVC_Ma10P.metalink 为例，用文本编辑打开它看到的是这样的内容：

```
     <?xml version="1.0" encoding="UTF-8"?>
     <metalink xmlns="urn:ietf:params:xml:ns:metalink">
       <!--发布时间-->
       <published>2027-10-5T18:20:56</published>
       <!--文件名-->
       <file name="[Fairyex][The Big Story Of SSpai][01][2160P][HEVC\_Ma10P][MKV].mkv">
     <!--文件大小-->
     <size>168846654235</size>
     <!--文件标识（作者）-->
     <identity>SSpai</identity>
     <!--文件版本-->
     <version>1.0</version>
     <!--文件语言-->
     <language>zh</language>
     <!--文件描述-->
     <description>这是少数派的大电影</description>
     <!--文件指纹-->
     <hash type="sha-256">36d622df738c86fece800fd8611eab7dc12dd57d661f2bfec602a590de331483</hash>
     <!--url：普通下载地址，metaurl：P2P 下载地址，priority：优先级-->
     <url location="zh" priority="1">ftp://ftp.sspai.com/moive.mkv</url>
     <url location="zh" priority="1">https://sspai.com/moive.mkv</url>
     <metaurl mediatype="torrent" priority="2">https://sspai.com/moive.torrent</metaurl>
    <metaurl mediatype="magnet" priority="3">magnet:?xt=urn:sha1:YNCNHJKIWBTRNJIV4YUAE52SJUQFGY4A</metaurl>
       </file>
     </metalink>
```

直白到你新建一个文本文件，按照上面格式照猫画虎地填入自己文件的数据, 就能创建这个文件的 Metalink（甚至都不用改文件格式名，txt 都行）。它并没有新酒，而是将不同的旧酒都装在一个新瓶子里，那这样子做的优点有啥呢？

Metalink 的优点
在用支持 Metalink 的下载客户端下载的时候，如果一个链接失效了，下载器会自动继续使用另一个链接继续下载。一个包含几十条 http、ftp、eD2K、种子地址和磁力链接的 Metalink 几乎不存在下载失败的可能（要是这几十条全部失效，你需要的不是这个文件，而是一个好运气......）

可以同时用不同的下载方式「混搭」下载文件的不同文件块（类似 BT 的文件分块），通过 Metalink 里面提供的多种文件校验方式实时校验文件，一旦发现下载错误的文件块会立即重新下载这部分文件块。
可以定义各种下载方式的优先级，比如我不想给少数派服务器太大压力，那么可以在 Metalink 文件里面设置优先用磁力链接下载大电影，如果磁力链接挂了再用 BT 种子下载，最后关头才用 http 从少数派服务器下载。

支持把下载信息包含在 HTTP 请求中，让用户不知道自己用的是 Metalink 方式下载。

#### UDP 协议

首先当然是下载方面啦，就以迅雷为例子，我们可以在迅雷的设置中看到 UDP 端口设置（迅雷默认会启用 UDP，没有关闭选项）。在非 P2P 下载（例如离线下载或者边下边看）的时候迅雷会用 UDP 传输数据，以保证我们能用最快的速度下载或者看到视频，还能节约服务器资源。有时候我们看到边下边看电影的时候可能会鬼畜一下，如果最后下回来的本地电影没有问题，那可能就是你的网络波动让 UDP 丢包了。

流媒体

我们平时视频聊天或者看直播的时候都会遇到过卡顿或者色块等等现象，这就是因为它们都是即时性比较高但是对数据完整性不那么苛刻的场景，所以全部是用 UDP 的方式传输数据的，这些卡顿和色块就是因为 UDP 丢包了。其中基于 UDP 的协议 Google 家的 WebRTC 已经成了流媒体传输的通用标准，是视频直播网站们的标配。

实时游戏

TCP 协议一旦发生丢包，它会将后续包缓存起来，等前面的包重传并接收到后再继续发送，丢的包越多延迟会越来越大。这对于一些必须实时性的场景比如对战游戏来讲简直就是灾难。
所以无论是电脑上的 CS：GO，Dota，LOL；索尼，微软，任天堂主机上面所有游戏的网络服务；再到手机上的王者荣耀，阴阳师，荒野行动等都采用 UDP 作为数据传输的方式。加上自定义的重传策略，能够把丢包产生的延迟降到最低，尽量减少网络波动对游戏性造成的影响，这才让实时对战游戏成为可能。现在知道为什么游戏的延时会让人物各种闪现鬼畜了吧（比如王者荣耀的 460ms），因为 UDP 会跳过丢失的数据包直接处理后面接收到的数据。

物联网

物联网也在设备之间的网络交流中用到了 UDP 协议，用以将网络控制的延时降低到与有线和红外遥控相差无几，而且还能降低设备的性能要求从而降低功耗。随着类似的场景越来越多，UDP 将会继续发光发热，直到有更好的协议将它代替。

#### PT 下载

之所以把 PT（Private Tracker，私有服务器）下载放到最后来讲，是因为它是下大文件最稳定也是门槛最高的下载方法。从英文名即可看出 PT 是将 BT 下载中开放的 Tracker 变为封闭私有的 Tracker，同时关闭 DHT 减少用户人数来达到建立资源爱好者们的「小圈子」的目的。

PT 的优势在于「保种」，普通的种子一旦过了热度最高的时候，下载人数会骤然降低，导致种子无法下载或者下载速度过慢。而 PT 论坛通过互利互惠的方式让论坛用户主动保持种子的热度，从而达到下载稀有资源和满速下载的目的。一般来讲国内 PT 论坛分享的主要是蓝光原盘和超高清（和谐）视频，主要的类目和大站可以看下面的图，想要知道最新最全的 PT 站只需要访问 https://opentrackers.org/tracker-list/。

PT 下载即是私密的 BT 下载，主体一般为PT 论坛。为了保证论坛资源的质量和下载速度，PT 论坛一般都不会开放注册，需要邀请人担保或者看管理员心情。一旦有幸进入一个 PT 站，那么对用户来讲最重要的应该就是 passkey 了。

Passkey 是一串字符，代表着用户在论坛里面的「代号」，那么有了它是不是就能随心所欲地下载资源了呢？并不是，为了让大家都能满速下载，PT 站会规定用户上传一定大小的数据才能下载一定大小的数据。也就是说新人必须先在论坛下载一些完整的资源，并且给其他用户提供一定量的数据之后 PT 站才会给他开放下载流量。现在许多 PT 论坛还有新人考核，必须在一定时间内完成要求（例如：30天内上传 20G，下载10G）才能成为论坛成员。

用户在 PT 站下载的所有种子都会带有专属的 passkey，PT 站会通过 passkey 确定用户的上传量，并按照一个特定的比率分配下载量。当然也只有通过论坛下载的带 passkey 的种子下载资源才能享受到满速下载的福利。

除了下载别人的资源，用户也可以上传自己资源来提高上传量，只需要将本地的私有种子上传到论坛生成一个带有 passkey 的种子，然后把种子下载回来本地做种就行了。一般 PT 论坛对上传资源的质量和内容有着严格的要求，这也是 PT 下载的优势之一。

对于违反论坛规定和没有贡献的用户 PT 论坛惩罚起来是毫不手软的，卖邀请卖号的立即删号，一段时间上传下载比率太低的立即删号，passkey 被泄露的立即删号（无法从技术手段根绝 passkey 泄露，所以 PT 论坛不允许使用迅雷等「吸血」客户端下载带 passkey的种子，只能用 μtorrent 等客户端），严格的 PT 论坛连一个人用多个账号或者多个人用一个账号都会被删号。


### 下载神器 Aria2

Aria2 是一个开源的命令行下轻量级（4-9MB占用）、多协议（支持 HTTP/HTTPS、FTP、BitTorrent 也就是 BT 下载、磁力链接、Metalink）、多来源（从多个源地址下载同一个文件）的下载工具，它的特点是可以轻松装在主流系统，路由器和 NAS 甚至旧手机上实现多线程同步下载多个文件，并且内存和 CPU 占用极少。

虽然它十分好用，以至于有许多用户直呼「替代迅雷」（目前来讲还是差太多了），不过 Aria2本身是通过命令行进行添加下载和暂停等操作的，操作起来门槛高又繁琐。看到这里大家也许会担心接下来文章会不会出现一堆代码，不用怕，Aria2 支持图形化界面通过接口控制，让它不至于变成极客们专属的玩具。随着用户的增多，各种傻瓜懒人一键安装包和好用的管理 App 也相继出现，只要花点时间就能轻松装上它。

Aria2 的优点
- Aria2 最大的优点，也是人们愿意不辞繁琐去用它的最大原因是隐私和文件安全保证。开源的 Aria2 确保不会将你下载的文件，机器上的其他文件或者个人信息上传到各种奇奇怪怪的公司和组织。不会像某些下载器一样拦截篡改下载文件，把某些文件变成「敏感资源」，只要你的地址正确有效，下载回来的一定是正确完整的文件。也不会有各种会员和超贵的正版费用，还三天两头要你更新。
支持全自动多线程下载和断点续传。这个是所有高级下载器都必须有的功能。
- 超级轻量化。官方测试的结果是普通下载占用 4MB 内存，BT 下载占用 9MB 内存，20M 宽带满速下载占用6% 的 CPU。 不说电脑，只要不是远古级别的手机，甚至普通的路由器都能轻松 Hold 住 Aria2。下载时不仅不会影响机器性能，挂机下载时还可以节约不少电。
BT 下载和 Metalink 支持。这是 macOS 和一众 Linux 系统的福音，从此种子和磁力链接可以通过自己的 VPS (Virtual Private Server，远程的私人服务器)或者 NAS (Network Attached Storage：网络附属存储，简单理解为私人云)离线下载。
- 支持 RPC（Remote Procedure Call，远程过程调用)远程控制。通俗的讲，Aria2 是一个「核」，它支持人们通过各自制作各种各样的「壳」来操作它。这个壳可以是一个 App，一个网站甚至一个本地网页，这些「壳」不仅没有其他下载器的各种花式广告，界面也相当的漂亮。当然有能力的朋友也可以自己动手写一个「壳」或者直接通过命令行操作 Aria2 实现高级自定义下载。

#### 搭配百度云


## 下载过程中的安全与隐私

### 文件安全——篡改很容易，改完难发现

首先我们需要了解到一个很关键的事实：HTTP 协议是明文传输数据的。像我们第一章提到的那样，浏览器中打开的控制台（快捷键 Windows：F12；macOS：⌥Option-⌘Command-I）中你可以看到所有 http 请求的内容，包括请求头，请求内容，回应头，回应内容和请求的文件等。

我们在自己设备上看到这些没有多大问题，因为这些内容本来就是要给我们的。但是，一旦别有用心的人在服务器发送到客户端之前拦截到这些数据，那么他想要解读或者修改这些明文的数据将「易如反掌」。并且由于 HTTP 只通过状态码来确认请求状态，我们根本无法确定收到的数据是否已经被篡改。
这就是在计算机安全领域中大名鼎鼎的中间人攻击（MITM，Man-in-the-middle attack），这是我们通过 http 方式下载文件的时候最有机会碰到的一种攻击方式。

为了更好地理解文件下载中的中间人攻击，我们来举一个例子：
- 小明和小方是亲密的好朋友，他们俩都偷偷地暗恋同班的小红。
- 上课的时候小明经常和小红传纸条，可是他和她的座位相隔太远了，所以纸条从小明手里经过几个同学的传递才到小红的手中。
- 小方很想知道小明有没有趁机抢先向小红表白，又有没有说自己的坏话。所以小方编了个理由和一个传纸条的同学交换了座位。
- 接下来每次小明的纸条传到小方手里都会被他打开看一遍，然后把一些告白和打情骂俏的内容全都换成夸自己的话，小红传回来的纸条也是一样。
- 由于小明和小红之间平时羞于谈话，所以小方一直没有被发现。


在下载的情境中纸条即是我们要下载的文件，攻击者只需要让将我们需要下载的文件替换成他们准备好的文件即可。中间人攻击的难点在于如何加入到通信过程中（也就是偷到钥匙），中间人一般是这几个身份：
1. 连接到 Wi-Fi 等局域网中的其他设备。这里分两种情况，一种是攻击者可以访问网关（路由器），比如「黑客」们经常在公共场合建立钓鱼 Wi-Fi，这种情况无需多说，「为所欲为」这个词可以说明一切，一切数据都可以被拦截。另外一种就是和你一样只是连接到同一个 Wi-Fi /局域网的设备，也可以发动中间人攻击（也被叫做 ARP 攻击），详情可以看下面的自己动手尝试中间人攻击。
2. 流氓软件。流氓软件和木马病毒一样，处于打击竞争对手和强行推广等目的，流氓软件直接在客户端篡改我们下载的文件。不同于木马病毒偷偷摸摸坏事的是，流氓软件需要用一个正当的理由掩饰这种行为。比如 3Q 大战的时候各家浏览器屏蔽或者篡改其他家软件的下载链接，浏览器就是下载器与服务器之间的那个「中间人」。
3. 硬件。像是攻击者贴在 ATM 密码输入器上的复制硬件和插在网关上的数据监控器都是「中间人」。
4. 监守自盗。平时我们使用某搜索引擎出来的网站经常先会瞬间跳转到一个地址再跳到我们想要访问的地址，然后你就会发现这个地址多了一些好像和网站本身风格好像不搭的广告（手机上更严重）；又或者你上着一个与运营商毫不相关的网站却弹出流量红包和流量球之类的推广，这个时候其实是某搜索引擎和这些运营商作为客户端和服务器的「中间人」劫持了你的请求。虽然不常见，不过这个时候它们是有能力篡改你的下载文件的，「监守自盗」这种中间人攻击最为防不胜防。


FTP 与 HTTP 采用了相同的底层协议，同时 FTP 也是明文传输协议，所以 FTP 的安全性问题可以参考 HTTP。
另外还有一种在各种公共场合很常见的攻击：Wi-Fi 解除认证攻击（Wi-Fi deauthentication attack）。它的原理就十分粗暴了，攻击者只需一个带有 Wi-Fi 的便宜开发板和一个移动电源即可。
我们平时连接或者断开 Wi-Fi 的时候设备都会发送一个数据包来告诉路由器我要连接/断开了，攻击者就是利用这一点。当攻击者启动开发板上的攻击程序之后，攻击程序会持续向路由器和连接设备（例如手机）发送断开连接的请求，让设备无法连接到指定的 Wi-Fi，整个过程就是这么简单。
听起来好像危害不大，实际上攻击者可以：

- 在设备重新向路由器发送连接请求的时候拦截数据包，通过暴力破解（也就是根据装满密码的密码词典一个个尝试常见密码，更暴力的是把所有可能的密码都试一遍）的方式破解 Wi-Fi 密码。
- 让周围的无线设备例如监控摄像头，物联网设备失效。
- 在酒店会议等场合让所有 Wi-Fi 都无法被设备连接，只留下攻击者自己开的钓鱼热点。
- 获得 Wi-Fi 密码后（例如饭店咖啡店等密码，或者按照第一条获取了密码），攻击者自己建立一个和原 Wi-Fi 相同 SSID（Wi-Fi 名字）和相同密码的钓鱼热点，然后攻击者迫使设备从原 Wi-Fi 断开后自动连接到钓鱼 Wi-Fi，接下来就是为所欲为的时间。


### 谁在监控——全世界都有能力看见你

就在前面我们就说了「监守自盗」的问题，所有能篡改文件的方式都能用来监视。由于 HTTP 明文传输的特性，监控起来可以说是十分轻松。
在国家层面，中国有公共信息网络安全监察（也就是常说的「网监、网络警察」），美国有 FBI 与 NSA；其他国家除了相关部门，还有各种专门与各个运营商与公司合作的律师事务所。这些部门可以在法律与政府的支持下合法地持续监控所有 HTTP 上传下载流量。
简单说一下 FBI 与 NSA 对于互联网信息的分工，NSA（National Security Agency）是负责信息收集这个方面的，像是前几年斯诺登曝光公众信息泄露和猖獗一时的 WannaCry 勒索病毒都和 NSA 脱不了干系。由于间谍与犯罪信息在没有确认之前界限非常模糊，所以 NSA 可以说「什么都管」。不过普通的互联网犯罪（例如违规 BT 下载）大部分时间还是 FBI（Federal Bureau of Investigation）负责的，当然 CIA 这个吃瓜群众有时候也会打打酱油。
国内相关法律与规定：《互联网信息服务管理办法》第十四条。

> 从事新闻、出版以及电子公告等服务项目的互联网信息服务提供者，应当记录提供的信息内容及其发布时间、互联网地址或者域名；
互联网接入服务提供者应当记录上网用户的上网时间、用户账号、互联网地址或者域名、主叫电话号码等信息。
互联网信息服务提供者和互联网接入服务提供者的记录备份应当保存 60 日，并在国家有关机关依法查询时，予以提供。

美国法律相关规定：

> Federal law provides severe civil and criminal penalties for the unauthorized reproduction,distribution ,or exhibition of copyrighted motion pictures (title 17,united states code,sections 501 and 508),the federal bureau of investigation investigates allegations of criminal copyright infringement (title 17,united states code,section 506)

根据联邦法律规定，凡对未经授权，而对受版权保护的电影作品进行复制、发行或公开展出者，可导致严厉的民事或刑事处分（美国联邦法典第 17 篇，第 501 条与 508 条）。美国联邦调查局负责调查侵犯版权的投诉 （美国联邦法典第 17 篇，第 506 条）。
上面就是大名鼎鼎的 FBI Warning，相信各位对它比对国内的法律更加熟悉吧。


在中国运营商层面，为了配合国家政策，所有网站主在使用网络运营商提供的网络服务或者主机运营商提供的云主机服务时都必须同意将数据公开透明地提供给网络监控部门。并且网站自己的存储设备上必须保存至少 2 个月的所有数据。这个执行力度非常足，像是直播网站甚至所有直播用户的录屏都必须保存 2 个月，下载记录啥的更不用说了。

在公共设施方面，例如：大学，公司，车站等。一般都可以看做一个大局域网，只需要在局域网出口处放置一个监控软件，局域网内所有的数据都跑不掉。特别是大学与公司这种需要进行人员网络行为管理的地方，一般来讲都会配置专用的网络行为管理软件，大家搜索「深信服、网路岗、WoekWin」等相关的网络行为管理软件就可以知道学校/公司的 IT 部门可以做到什么程度了。

公共设施监控这方面，国外与国内差不多，甚至国外要更为严重。具体到各个国家太复杂，这里就不细讲
监控本身不是坏事，因为我们每时每刻都处于被监控的情景之下，监控可以更好地保证国家主权和个人的生命财产安全。侵犯隐私与否要看数据是否用于特例分析，如果这些最后会被匿名化用作大数据分析，对于个人来讲这些数据将毫无意义。

### eD2K 与 BT 下载正版资源时保护自己的权利

最安全的就是使用 BT 做它该做的事情，例如下载开源系统或者非版权资源。下面的建议更偏向于在国外下载正版资源时保证安全。国内个人下载只要不触及几条底线，不担心监控问题基本没有法律问题。
不要在公共网络使用，在私人网络下载

无论是在国内外，学校与公司这种地方最好不要使用 BT 下载。特别是在国外，像是日本或者美国，这些国家对学校公司的对外流量控制特别严格，加上 BT「边上传边下载」的特性很容易给自己惹上警察。相比而言私人住宅就安全许多，毕竟国外私人领域的权限很高，很多美国人本身也在家用这些方式下载。
不要大流量

大部分运营商其实不会浪费资源去一个个去检测用户下载了什么，只有当某个用户的 BT 下载/上传流量异常才会检查你是否下了不能下的文件然后警告+断网，如果多次被运营商警告你的个人信息是有可能被提交到版权方手里面的。

尽量限制上传流量
相比下载流量，运营商对 BT 上传流量检测更为严格，而且一旦你在下载的时候有上传的行为即是触犯了法律。可能会面临罚款等惩罚（被版权公司委托的律师事务所会根据运营商提供的信息对所有触犯法律的用户发起共同诉讼。）

不过限制上传流量之后下载速度会变慢，因为 BT 协议会根据上传速度来分配下载速度。还有一个很难注意的点是许多视频网站（特别是国外朋友用代理上中国视频网站的时候）的客户端都会默认开启 P2P 来缓解服务器压力，请使用这些客户端之前注意相关的事项。

此外还有使用代理或者虚拟专用网络下载，和避免在头 60 天下载资源，尽量下载非本国资源两种方法。由于相关原因不适合在文中讨论。

#### 磁力链接安全，监控和法律问题

我们平时使用迅雷下载磁力链接，有时候会发现最后还是会下载一个种子文件。理论上磁力链接不需要 Tracker 也可以实现下载任意文件，但是国内很多网站只是为了规避法律风险直接把种子文件转换成磁力链接，实际上我们是先通过 P2P 下载种子再通过种子下载文件。

这种情况下的确可以保证种子的存活率，不过剩下就相当于传统的 BT 下载了。只有真正的通过 DHT 网络获取数据的下载才可以避免监控问题。

最后我解答一个终极问题，有没有百分百安全，不会受到监控的方式去下载文件呢？答案是百分百没有，不过还是有几种方法可以无限接近这个目标。
